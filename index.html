<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üõí Tem Tudo ‚Äì Utilidades e Variedades</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins}
body{margin:0;background:#f2f4f7}
body.dark{background:#111;color:#fff}
header{background:#111;color:#fff;padding:15px;text-align:center}
footer{text-align:center;padding:10px;font-size:13px;opacity:.7}
.section{background:#fff;margin:20px;padding:20px;border-radius:14px}
body.dark .section{background:#1f1f1f}
button,input,textarea,select{
 width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc
}
button{background:#111;color:#fff;font-weight:600;cursor:pointer}

/* Grid com Rolagem Horizontal */
.grid-horizontal {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding-bottom: 15px;
    scroll-behavior: smooth;
}

.grid-horizontal::-webkit-scrollbar {
    height: 8px;
}

.grid-horizontal::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

body.dark .grid-horizontal::-webkit-scrollbar-track {
    background: #333;
}

.grid-horizontal::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.grid-horizontal::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.card { 
    position: relative; 
    overflow: visible; 
    background: #fff; 
    padding: 10px; 
    border-radius: 12px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    flex-shrink: 0;
    width: 220px;
    min-width: 220px;
}
body.dark .card { background: #2a2a2a; }

.img-container { position: relative; width: 100%; height: 150px; overflow: hidden; border-radius: 10px; cursor: crosshair; }
.card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.1s ease; }
.zoom-lens {
    position: absolute;
    border: 1px solid #d4d4d4;
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.4);
    display: none;
    pointer-events: none;
}

.price{color:green;font-weight:600}
.hide{display:none}
.admin-btn{background:#ff9800;color:#000}

.chart-container { width: 80%; margin: 0 auto; height: 200px; }
#grafico{width:100%!important;height:100%!important}

#assinatura{width:240px;height:70px;border:2px dashed #999;border-radius:10px}
body.dark #assinatura{border-color:#bbb}

.prod-admin{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:10px}
.prod-admin-info{flex:1}
.prod-admin-actions{display:flex;gap:5px}
.prod-admin-actions button{width:auto;padding:5px 10px}
.search-filter-container{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.search-filter-container input{flex:2;min-width:200px}
.search-filter-container select{flex:1;min-width:150px}
.timestamp{font-size:11px;color:#666;font-style:italic}
body.dark .timestamp{color:#aaa}

.status-icon { font-size: 18px; margin-right: 8px; }
.status-fechado { color: #4CAF50; }
.status-andamento { color: #FF9800; }

.lote-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; }
.lote-header { display: flex; gap: 10px; align-items: center; }
.lote-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
.lote-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
.lote-inputs input, .lote-inputs select { margin-top: 0; }

/* Hist√≥rico com Rolagem Horizontal */
.hist-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.hist-item { 
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: #f9f9f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

body.dark .hist-item {
    background: #2a2a2a;
    border-color: #444;
}

.hist-info { flex: 1; min-width: 200px; }
.hist-actions { 
    display: flex; 
    gap: 5px; 
    flex-wrap: wrap; 
    justify-content: flex-end;
    min-width: 300px;
}
.hist-actions button { width: auto; padding: 5px 10px; margin-top: 0; font-size: 12px; }

/* Categoria Badge */
.categoria-badge {
    display: inline-block;
    background: #2196F3;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 5px;
}

/* WhatsApp Floating Button */
.whatsapp-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

.whatsapp-btn {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #25D366 0%, #20BA5A 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
    transition: all 0.3s ease;
    border: none;
    color: white;
    font-size: 28px;
}

.whatsapp-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
}

.whatsapp-menu {
    position: absolute;
    bottom: 80px;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 12px;
    min-width: 250px;
    display: none;
}

.whatsapp-menu.show {
    display: block;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.whatsapp-menu input {
    width: 100%;
    padding: 8px;
    margin-bottom: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.whatsapp-menu button {
    width: 100%;
    padding: 8px;
    background: #25D366;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    margin-top: 0;
}

.whatsapp-menu button:hover {
    background: #20BA5A;
}

.whatsapp-info {
    font-size: 12px;
    color: #666;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

.whatsapp-number-display {
    font-size: 13px;
    color: #25D366;
    font-weight: 600;
    margin-top: 6px;
}

body.dark .whatsapp-menu {
    background: #1f1f1f;
    color: #fff;
}

body.dark .whatsapp-menu input {
    background: #2a2a2a;
    color: #fff;
    border-color: #444;
}

body.dark .whatsapp-info {
    color: #aaa;
    border-top-color: #444;
}

/* Alertas de Produtos Incompletos */
.alert-incompletos {
    background: #fff3cd;
    border: 2px solid #ffc107;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    color: #856404;
}

body.dark .alert-incompletos {
    background: #664d03;
    border-color: #997404;
    color: #ffecb5;
}

.alert-incompletos strong {
    display: block;
    margin-bottom: 8px;
}

.alert-incompletos button {
    width: auto;
    padding: 8px 15px;
    background: #ffc107;
    color: #000;
    margin-top: 8px;
}

/* Produto Incompleto */
.produto-incompleto {
    border: 2px solid #ff9800;
    background: #fff3e0;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    gap: 15px;
}

body.dark .produto-incompleto {
    background: #e65100;
    border-color: #ff6f00;
}

.produto-incompleto-img {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.produto-incompleto-info {
    flex: 1;
}

.produto-incompleto-info h5 {
    margin-top: 0;
    color: #e65100;
}

body.dark .produto-incompleto-info h5 {
    color: #ffb74d;
}

.falta-info {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 10px 0;
}

.falta-item {
    background: #ff5722;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
}

.produto-incompleto-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.produto-incompleto-actions button {
    width: auto;
    padding: 8px 12px;
    font-size: 12px;
    margin-top: 0;
}

/* Categorias */
.categoria-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #f9f9f9;
}

body.dark .categoria-item {
    background: #2a2a2a;
    border-color: #444;
}

.categoria-item button {
    width: auto;
    padding: 5px 10px;
    font-size: 12px;
    margin-top: 0;
}

/* Filtro de Data */
.filtro-data-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.filtro-data-container input {
    flex: 1;
    min-width: 150px;
    margin-top: 0;
}

.filtro-data-container button {
    width: auto;
    padding: 10px 15px;
    margin-top: 0;
}
</style>
</head>

<body>

<header>
<h2>üõí Tem Tudo ‚Äì Utilidades e Variedades</h2>
<button onclick="toggleTheme()">üåó Claro / Escuro</button>
</header>

<!-- LOGIN -->
<div id="telaLogin" class="section" style="max-width:400px;margin:50px auto">
<h3>Login</h3>
<input id="usuario" placeholder="Usu√°rio" value="admin">
<input id="senha" type="password" placeholder="Senha" value="1234">
<button onclick="fazerLogin()">Entrar</button>
<button onclick="criarNovoUsuario()" style="background:#2196F3">Criar Novo Usu√°rio</button>
</div>

<!-- CRIAR NOVO USU√ÅRIO -->
<div id="telaCriarUsuario" class="section hide" style="max-width:400px;margin:50px auto">
<h3>Criar Novo Usu√°rio</h3>
<input id="novoUsuario" placeholder="Novo Usu√°rio">
<input id="novaSenha" type="password" placeholder="Senha">
<input id="novaConfirmaSenha" type="password" placeholder="Confirmar Senha">
<button onclick="salvarNovoUsuario()">Criar</button>
<button onclick="voltarLogin()" style="background:#f44336">Voltar</button>
</div>

<!-- CAT√ÅLOGO -->
<div id="telaCatalogo" class="section hide">
<h3>Cat√°logo</h3>
<div class="search-filter-container">
 <input id="busca" placeholder="üîç Buscar no cat√°logo..." oninput="renderCatalogo()">
 <select id="ordenacao" onchange="renderCatalogo()">
  <option value="relevancia">Mais Relevante</option>
  <option value="preco-asc">Menor Pre√ßo</option>
  <option value="preco-desc">Maior Pre√ßo</option>
 </select>
 <select id="filtroCategoria" onchange="renderCatalogo()">
  <option value="">Todas as Categorias</option>
 </select>
</div>
<div id="formaPagamentoSection" style="margin-bottom:15px;">
 <label>Forma de pagamento:</label>
 <select id="pagamento"></select>
</div>
<p>Total: R$ <span id="total">0.00</span></p>
<div id="assinaturaPedido">
 <canvas id="assinatura"></canvas>
</div>
<button onclick="limparAssinatura()">Limpar Assinatura</button>
<button onclick="salvarPedido()" style="background:#4CAF50">üíæ Salvar Pedido</button>
<button onclick="fecharPedido()" style="background:#2196F3">Fechar Pedido</button>
<button onclick="abrirHistorico()" style="background:#ff9800">üìã Hist√≥rico de Pedidos</button>
<button onclick="limparHistorico()" style="background:#f44336">üóëÔ∏è Limpar Hist√≥rico</button>
<button onclick="abrirAdmin()" style="background:#ff9800" class="admin-btn">üîß Painel Administrativo</button>
<button onclick="fazerLogout()" style="background:#f44336">Logout</button>
</div>

<!-- CAT√ÅLOGO DE PRODUTOS -->
<div id="telaCatalogoProdutos" class="section hide">
<h3>Cat√°logo de Produtos</h3>
<div id="catalogo" class="grid-horizontal"></div>
</div>

<!-- PAINEL ADMINISTRATIVO -->
<div id="telaAdmin" class="section hide">
<h3>Painel Administrativo</h3>

<!-- Gr√°fico -->
<div class="chart-container">
 <canvas id="grafico"></canvas>
</div>

<!-- Gerenciar Categorias -->
<h4>üìÇ Gerenciar Categorias</h4>
<button onclick="abrirFormCategoria()" style="background:#4CAF50">‚ûï Adicionar Categoria</button>
<div id="listaCategorias"></div>

<!-- Cadastro de Produto -->
<h4>üì¶ Cadastro de Produto</h4>
<input id="pDesc" placeholder="Descri√ß√£o">
<textarea id="pDescricao" placeholder="Descri√ß√£o detalhada"></textarea>
<input id="pPreco" type="number" placeholder="Pre√ßo" step="0.01">
<input id="pEAN" placeholder="EAN-13">
<select id="pCategoria"></select>
<button onclick="selecionarImagem()" style="background:#2196F3">Selecionar Imagem</button>
<input type="file" id="pImagem" accept="image/*" style="display:none" onchange="processarImagem()">
<button onclick="salvarProduto()" style="background:#4CAF50">üíæ Salvar Produto</button>

<!-- Produtos Incompletos -->
<h4>‚ö†Ô∏è Produtos Incompletos (Pend√™ncias em Edi√ß√£o)</h4>
<div id="produtosIncompletos"></div>

<!-- Importa√ß√£o em Lote -->
<h4>üì• Importa√ß√£o em Lote</h4>
<input type="file" id="pLote" multiple accept="image/*" onchange="prepararLote(this)">
<div id="areaLote" class="hide">
 <div id="listaLote"></div>
 <button onclick="salvarLote()" style="background:#4CAF50">‚úÖ Salvar Lote</button>
</div>

<!-- Criar Usu√°rio -->
<h4>üë§ Criar Usu√°rio</h4>
<input id="novoUsuarioAdmin" placeholder="Usu√°rio">
<input id="novaSenhaAdmin" type="password" placeholder="Senha">
<select id="novoNivelAdmin">
 <option value="cliente">Cliente</option>
 <option value="admin">Admin</option>
</select>
<button onclick="criarUsuarioAdmin()" style="background:#2196F3">Criar Usu√°rio</button>

<!-- Formas de Pagamento -->
<h4>üí≥ Formas de Pagamento</h4>
<input id="novaFormaPagamento" placeholder="Nome da forma de pagamento">
<button onclick="adicionarFormaPagamento()" style="background:#4CAF50">Adicionar</button>
<div id="listaFormasPagamento"></div>

<!-- Contatos -->
<h4>üìß Criar Usu√°rio</h4>
<input id="contatoNome" placeholder="Nome">
<input id="contatoEmail" placeholder="Email">
<input id="contatoTelefone" placeholder="Telefone">
<textarea id="contatoMensagem" placeholder="Mensagem"></textarea>
<button onclick="criarContato()" style="background:#2196F3">Enviar Contato</button>

<!-- Configurar WhatsApp -->
<h4>üì± Configurar WhatsApp</h4>
<input id="whatsappPhone" placeholder="N√∫mero de WhatsApp (ex: 5511999999999)">
<button onclick="salvarWhatsApp()" style="background:#25D366">Salvar N√∫mero WhatsApp</button>

<!-- Produtos Cadastrados -->
<h4>üì¶ Hist√≥rico</h4>
<div id="historicoAdmin"></div>

<button onclick="voltarCatalogo()" style="background:#f44336">Voltar</button>
</div>

<!-- HIST√ìRICO DE PEDIDOS -->
<div id="telaHistorico" class="section hide">
<h3>Hist√≥rico de Pedidos</h3>
<div class="filtro-data-container">
 <input type="date" id="filtroData" onchange="filtrarHistoricoPorData()">
 <select id="filtroMes" onchange="filtrarHistoricoPorData()">
  <option value="">Todos os Meses</option>
  <option value="01">Janeiro</option>
  <option value="02">Fevereiro</option>
  <option value="03">Mar√ßo</option>
  <option value="04">Abril</option>
  <option value="05">Maio</option>
  <option value="06">Junho</option>
  <option value="07">Julho</option>
  <option value="08">Agosto</option>
  <option value="09">Setembro</option>
  <option value="10">Outubro</option>
  <option value="11">Novembro</option>
  <option value="12">Dezembro</option>
 </select>
 <select id="filtroAno" onchange="filtrarHistoricoPorData()"></select>
 <button onclick="limparFiltrosData()" style="background:#f44336">Limpar Filtros</button>
</div>
<div id="listaHistorico" class="hist-container"></div>
<button onclick="voltarCatalogo()" style="background:#f44336">Voltar</button>
</div>

<footer>Desenvolvido por: Andrews Pablo!</footer>

<!-- WhatsApp Floating Button -->
<div class="whatsapp-container">
    <button class="whatsapp-btn" onclick="toggleWhatsAppMenu()">üí¨</button>
    <div class="whatsapp-menu" id="whatsappMenu">
        <input type="text" id="whatsappMsgInput" placeholder="Sua mensagem...">
        <button onclick="enviarWhatsApp()">Enviar</button>
        <div class="whatsapp-info">
            <p>Conecte-se conosco via WhatsApp</p>
            <div class="whatsapp-number-display" id="whatsappNumberDisplay">N√∫mero n√£o configurado</div>
        </div>
    </div>
</div>

<script>
// ========== CONFIGURA√á√ÉO DA API ==========
const API_URL = 'https://temtudo1.onrender.com/api';

// ========== FUN√á√ïES DE API ==========
async function criarUsuarioAPI(usuario) {
  try {
    const response = await fetch(`${API_URL}/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(usuario)
    });
    const data = await response.json();
    if(data.success) console.log('‚úÖ Usu√°rio criado na API');
    return data;
  } catch(err) {
    console.error('‚ùå Erro ao criar usu√°rio:', err);
  }
}

async function criarCategoriaAPI(categoria) {
  try {
    const response = await fetch(`${API_URL}/categories`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(categoria)
    });
    const data = await response.json();
    if(data.success) console.log('‚úÖ Categoria criada na API');
    return data;
  } catch(err) {
    console.error('‚ùå Erro ao criar categoria:', err);
  }
}

async function criarProdutoAPI(produto) {
  try {
    const response = await fetch(`${API_URL}/products`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(produto)
    });
    const data = await response.json();
    if(data.success) console.log('‚úÖ Produto criado na API');
    return data;
  } catch(err) {
    console.error('‚ùå Erro ao criar produto:', err);
  }
}

async function criarPedidoAPI(pedido) {
  try {
    const response = await fetch(`${API_URL}/orders`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(pedido)
    });
    const data = await response.json();
    if(data.success) console.log('‚úÖ Pedido criado na API');
    return data;
  } catch(err) {
    console.error('‚ùå Erro ao criar pedido:', err);
  }
}

async function criarFormaPagamentoAPI(formaPagamento) {
  try {
    const response = await fetch(`${API_URL}/payment-methods`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formaPagamento)
    });
    const data = await response.json();
    if(data.success) console.log('‚úÖ Forma de pagamento criada na API');
    return data;
  } catch(err) {
    console.error('‚ùå Erro ao criar forma de pagamento:', err);
  }
}

async function criarContatoAPI(contato) {
  try {
    const response = await fetch(`${API_URL}/contacts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(contato)
    });
    const data = await response.json();
    if(data.success) console.log('‚úÖ Contato criado na API');
    return data;
  } catch(err) {
    console.error('‚ùå Erro ao criar contato:', err);
  }
}

async function salvarWhatsAppAPI(whatsapp) {
  try {
    const response = await fetch(`${API_URL}/whatsapp`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(whatsapp)
    });
    const data = await response.json();
    if(data.success) console.log('‚úÖ WhatsApp salvo na API');
    return data;
  } catch(err) {
    console.error('‚ùå Erro ao salvar WhatsApp:', err);
  }
}

// ========== VARI√ÅVEIS GLOBAIS ==========
let usuarioLogado = null;
let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [{nome:"admin",senha:"1234",nivel:"admin"}];
let categorias = JSON.parse(localStorage.getItem("categorias")) || [];
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
let formasPagamento = JSON.parse(localStorage.getItem("formasPagamento")) || ["Dinheiro","D√©bito","Cr√©dito"];
let contatos = JSON.parse(localStorage.getItem("contatos")) || [];
let whatsappPhone = localStorage.getItem("whatsappPhone") || "";
let produtosIncompletos = JSON.parse(localStorage.getItem("produtosIncompletos")) || [];
let carrinho = {};
let pedidoSendoEditadoIdx = -1;
let editandoIndice = -1;
let itensLote = [];
let pedidosFiltrados = [];
let graficoInstancia = null;

// ========== ELEMENTOS DO DOM ==========
const telaLogin = document.getElementById("telaLogin");
const telaCatalogo = document.getElementById("telaCatalogo");
const telaAdmin = document.getElementById("telaAdmin");
const telaHistorico = document.getElementById("telaHistorico");
const telaCatalogoProdutos = document.getElementById("telaCatalogoProdutos");
const telaCriarUsuario = document.getElementById("telaCriarUsuario");
const usuario = document.getElementById("usuario");
const senha = document.getElementById("senha");
const busca = document.getElementById("busca");
const catalogo = document.getElementById("catalogo");
const total = document.getElementById("total");
const pagamento = document.getElementById("pagamento");
const pDesc = document.getElementById("pDesc");
const pDescricao = document.getElementById("pDescricao");
const pPreco = document.getElementById("pPreco");
const pEAN = document.getElementById("pEAN");
const pCategoria = document.getElementById("pCategoria");
const pImagem = document.getElementById("pImagem");
const pLote = document.getElementById("pLote");
const areaLote = document.getElementById("areaLote");
const listaLote = document.getElementById("listaLote");
const listaHistorico = document.getElementById("listaHistorico");
const historicoAdmin = document.getElementById("historicoAdmin");
const c = document.getElementById("assinatura");
const ctx = c.getContext("2d");
const listaCategorias = document.getElementById("listaCategorias");
const listaFormasPagamento = document.getElementById("listaFormasPagamento");
const novaFormaPagamento = document.getElementById("novaFormaPagamento");
const contatoNome = document.getElementById("contatoNome");
const contatoEmail = document.getElementById("contatoEmail");
const contatoTelefone = document.getElementById("contatoTelefone");
const contatoMensagem = document.getElementById("contatoMensagem");
const whatsappPhone = document.getElementById("whatsappPhone");
const whatsappMenu = document.getElementById("whatsappMenu");
const whatsappNumberDisplay = document.getElementById("whatsappNumberDisplay");

// ========== INICIALIZA√á√ÉO ==========
window.addEventListener("load", () => {
  atualizarListaFormasPagamento();
  atualizarListaCategorias();
  atualizarPCategoria();
  atualizarFiltroCategoria();
  atualizarHistorico();
  if(whatsappPhone) {
    whatsappPhone.value = whatsappPhone;
    whatsappNumberDisplay.textContent = whatsappPhone;
  }
});

// ========== TEMA ESCURO/CLARO ==========
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem("tema", document.body.classList.contains("dark") ? "dark" : "light");
}

if(localStorage.getItem("tema") === "dark") document.body.classList.add("dark");

// ========== LOGIN ==========
function fazerLogin(){
  const u = usuario.value.trim();
  const s = senha.value;
  const usuarioEncontrado = usuarios.find(x => x.nome === u && x.senha === s);
  
  if(usuarioEncontrado){
    usuarioLogado = usuarioEncontrado;
    localStorage.setItem("usuarioLogado", JSON.stringify(usuarioLogado));
    telaLogin.classList.add("hide");
    telaCatalogo.classList.remove("hide");
    telaCatalogoProdutos.classList.remove("hide");
    renderCatalogo();
  } else {
    alert("Usu√°rio ou senha incorretos!");
  }
}

function criarNovoUsuario(){
  telaLogin.classList.add("hide");
  telaCriarUsuario.classList.remove("hide");
}

function voltarLogin(){
  telaCriarUsuario.classList.add("hide");
  telaLogin.classList.remove("hide");
}

function salvarNovoUsuario(){
  const novoUsuario = document.getElementById("novoUsuario").value.trim();
  const novaSenha = document.getElementById("novaSenha").value;
  const novaConfirmaSenha = document.getElementById("novaConfirmaSenha").value;
  
  if(!novoUsuario || !novaSenha) {
    alert("Preencha todos os campos!");
    return;
  }
  
  if(novaSenha !== novaConfirmaSenha) {
    alert("As senhas n√£o conferem!");
    return;
  }
  
  if(usuarios.find(x => x.nome === novoUsuario)) {
    alert("Este usu√°rio j√° existe!");
    return;
  }
  
  const novoUsuarioObj = { nome: novoUsuario, senha: novaSenha, nivel: "cliente" };
  usuarios.push(novoUsuarioObj);
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  
  // Enviar para API
  criarUsuarioAPI({
    name: novoUsuario,
    password: novaSenha,
    level: "cliente"
  });
  
  alert("Usu√°rio criado com sucesso!");
  voltarLogin();
}

function fazerLogout(){
  usuarioLogado = null;
  localStorage.removeItem("usuarioLogado");
  telaLogin.classList.remove("hide");
  telaCatalogo.classList.add("hide");
  telaAdmin.classList.add("hide");
  telaHistorico.classList.add("hide");
  telaCatalogoProdutos.classList.add("hide");
  usuario.value = "";
  senha.value = "";
}

// ========== CAT√ÅLOGO ==========
function renderCatalogo(){
  const buscar = busca.value.toLowerCase();
  const ordenacao = document.getElementById("ordenacao").value;
  const filtroCategoria = document.getElementById("filtroCategoria").value;
  
  let produtosFiltrados = produtos.filter(p => 
    (p.desc.toLowerCase().includes(buscar) || p.preco.toString().includes(buscar)) &&
    (!filtroCategoria || p.categoria === filtroCategoria)
  );
  
  if(ordenacao === "preco-asc") produtosFiltrados.sort((a,b) => a.preco - b.preco);
  else if(ordenacao === "preco-desc") produtosFiltrados.sort((a,b) => b.preco - a.preco);
  
  catalogo.innerHTML = "";
  produtosFiltrados.forEach((p,i) => {
    const idx = produtos.indexOf(p);
    catalogo.innerHTML += `
      <div class="card">
        <div class="img-container">
          <img src="${p.img}" alt="${p.desc}">
        </div>
        <strong>${p.desc}</strong>
        <p class="price">R$ ${p.preco.toFixed(2)}</p>
        <small>${p.categoria}</small>
        <input type="number" id="qtd${idx}" min="1" value="1">
        <button onclick="adicionarCarrinho(${idx})">‚ûï Adicionar</button>
      </div>`;
  });
}

function atualizarFiltroCategoria(){
  const select = document.getElementById("filtroCategoria");
  select.innerHTML = '<option value="">Todas as Categorias</option>';
  categorias.forEach(cat => {
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}

function adicionarCarrinho(i){
  const qtd = parseInt(document.getElementById(`qtd${i}`).value) || 1;
  if(!carrinho[i]) carrinho[i] = 0;
  carrinho[i] += qtd;
  atualizarTotal();
  renderCatalogo();
}

function atualizarTotal(){
  let soma = 0;
  for(let i in carrinho) {
    soma += produtos[i].preco * carrinho[i];
  }
  total.innerText = soma.toFixed(2);
}

// ========== ASSINATURA ==========
let desenhando = false;
c.addEventListener("mousedown", () => desenhando = true);
c.addEventListener("mouseup", () => desenhando = false);
c.addEventListener("mousemove", (e) => {
  if(!desenhando) return;
  const rect = c.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  ctx.fillStyle = "#111";
  ctx.beginPath();
  ctx.arc(x, y, 2, 0, Math.PI * 2);
  ctx.fill();
});

function limparAssinatura(){
  ctx.clearRect(0, 0, c.width, c.height);
}

// ========== PEDIDOS ==========
function salvarPedido(){
  const timestamp = new Date().toLocaleString('pt-BR');
  const [dia, mes, ano] = timestamp.split(' ')[0].split('/');
  const data = `${dia}/${mes}/${ano}`;
  
  const pedido = {
    itens: JSON.parse(JSON.stringify(carrinho)),
    total: parseFloat(total.innerText),
    pagamento: pagamento.value,
    data: data,
    status: "em andamento",
    assinatura: c.toDataURL()
  };
  
  if(pedidoSendoEditadoIdx >= 0) {
    pedidos[pedidoSendoEditadoIdx] = pedido;
    pedidoSendoEditadoIdx = -1;
  } else {
    pedidos.push(pedido);
  }
  
  localStorage.setItem("pedidos", JSON.stringify(pedidos));
  alert("Pedido salvo com sucesso!");
  atualizarHistorico();
}

function fecharPedido(){
  if(!Object.keys(carrinho).length) {
    alert("Carrinho vazio!");
    return;
  }
  
  const timestamp = new Date().toLocaleString('pt-BR');
  const [dia, mes, ano] = timestamp.split(' ')[0].split('/');
  const data = `${dia}/${mes}/${ano}`;
  
  const pedido = {
    itens: JSON.parse(JSON.stringify(carrinho)),
    total: parseFloat(total.innerText),
    pagamento: pagamento.value,
    data: data,
    status: "fechado",
    assinatura: c.toDataURL()
  };
  
  if(pedidoSendoEditadoIdx >= 0) {
    pedidos[pedidoSendoEditadoIdx] = pedido;
    pedidoSendoEditadoIdx = -1;
  } else {
    pedidos.push(pedido);
  }
  
  localStorage.setItem("pedidos", JSON.stringify(pedidos));
  
  // Enviar para API
  criarPedidoAPI({
    user_id: null,
    total_price: parseFloat(total.innerText),
    status: 'completed',
    payment_method: pagamento.value
  });
  
  alert("Pedido fechado com sucesso!");
  limparCamposPedido();
  atualizarHistorico();
}

function limparCamposPedido(){
  carrinho = {};
  total.innerText = "0.00";
  pagamento.value = "";
  ctx.clearRect(0, 0, c.width, c.height);
  renderCatalogo();
}

// ========== CATEGORIAS ==========
function abrirFormCategoria(){
  const nome = prompt("Nome da categoria:");
  if(!nome) return;
  
  if(categorias.includes(nome)) {
    alert("Esta categoria j√° existe!");
    return;
  }
  
  categorias.push(nome);
  localStorage.setItem("categorias", JSON.stringify(categorias));
  
  // Enviar para API
  criarCategoriaAPI({
    name: nome,
    description: ""
  });
  
  atualizarListaCategorias();
  atualizarPCategoria();
  atualizarFiltroCategoria();
}

function atualizarListaCategorias(){
  listaCategorias.innerHTML = "";
  categorias.forEach((cat, i) => {
    listaCategorias.innerHTML += `
      <div class="categoria-item">
        <span>${cat}</span>
        <button onclick="excluirCategoria(${i})" style="background:#f44336;">üóëÔ∏è</button>
      </div>`;
  });
}

function excluirCategoria(i){
  if(confirm("Deseja excluir esta categoria?")) {
    categorias.splice(i, 1);
    localStorage.setItem("categorias", JSON.stringify(categorias));
    atualizarListaCategorias();
    atualizarPCategoria();
    atualizarFiltroCategoria();
  }
}

function atualizarPCategoria(){
  pCategoria.innerHTML = '<option value="">Sem categoria</option>';
  categorias.forEach(cat => {
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    pCategoria.appendChild(option);
  });
}

// ========== PRODUTOS ==========
function selecionarImagem(){
  pImagem.click();
}

function processarImagem(){
  const file = pImagem.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    // Armazenar imagem em base64
  };
  reader.readAsDataURL(file);
}

function salvarProduto(){
  const desc = pDesc.value.trim();
  const preco = parseFloat(pPreco.value);
  const ean = pEAN.value.trim();
  const categoria = pCategoria.value;
  
  if(!desc || !preco) {
    alert("Preencha descri√ß√£o e pre√ßo!");
    return;
  }
  
  const timestamp = new Date().toLocaleString('pt-BR');
  
  if(editandoIndice >= 0) {
    produtos[editandoIndice] = { desc, preco, ean, categoria, img: produtos[editandoIndice].img, criadoEm: produtos[editandoIndice].criadoEm, ultimaEdicao: timestamp };
    editandoIndice = -1;
  } else {
    produtos.push({ desc, preco, ean, categoria, img: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==", criadoEm: timestamp, ultimaEdicao: timestamp });
  }
  
  localStorage.setItem("produtos", JSON.stringify(produtos));
  
  // Enviar para API
  criarProdutoAPI({
    name: desc,
    description: pDescricao.value,
    price: preco,
    category_id: null,
    image_url: "",
    stock: 0,
    ean: ean
  });
  
  alert("Produto salvo com sucesso!");
  pDesc.value = "";
  pDescricao.value = "";
  pPreco.value = "";
  pEAN.value = "";
  pCategoria.value = "";
  atualizarAdmin();
  renderCatalogo();
}

// ========== FORMAS DE PAGAMENTO ==========
function adicionarFormaPagamento(){
  const nome = novaFormaPagamento.value.trim();
  if(!nome) {
    alert("Digite o nome da forma de pagamento!");
    return;
  }
  
  if(formasPagamento.includes(nome)) {
    alert("Esta forma de pagamento j√° existe!");
    return;
  }
  
  formasPagamento.push(nome);
  localStorage.setItem("formasPagamento", JSON.stringify(formasPagamento));
  
  // Enviar para API
  criarFormaPagamentoAPI({
    name: nome,
    description: ""
  });
  
  novaFormaPagamento.value = "";
  atualizarListaFormasPagamento();
  atualizarPaginaPagamento();
}

function atualizarListaFormasPagamento(){
  listaFormasPagamento.innerHTML = "";
  formasPagamento.forEach((forma, i) => {
    listaFormasPagamento.innerHTML += `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px;background:#f9f9f9;">
        <span>${forma}</span>
        <button onclick="excluirFormaPagamento(${i})" style="width:auto;padding:5px 10px;background:#f44336;margin-top:0;">üóëÔ∏è</button>
      </div>`;
  });
}

function excluirFormaPagamento(i){
  if(confirm("Deseja excluir esta forma de pagamento?")) {
    formasPagamento.splice(i, 1);
    localStorage.setItem("formasPagamento", JSON.stringify(formasPagamento));
    atualizarListaFormasPagamento();
    atualizarPaginaPagamento();
  }
}

function atualizarPaginaPagamento(){
  pagamento.innerHTML = "";
  formasPagamento.forEach(forma => {
    const option = document.createElement("option");
    option.value = forma;
    option.textContent = forma;
    pagamento.appendChild(option);
  });
}

// ========== CONTATOS ==========
function criarContato(){
  const nome = contatoNome.value.trim();
  const email = contatoEmail.value.trim();
  const telefone = contatoTelefone.value.trim();
  const mensagem = contatoMensagem.value.trim();
  
  if(!nome || !email) {
    alert("Preencha nome e email!");
    return;
  }
  
  const contato = { nome, email, telefone, mensagem, data: new Date().toLocaleString('pt-BR') };
  contatos.push(contato);
  localStorage.setItem("contatos", JSON.stringify(contatos));
  
  // Enviar para API
  criarContatoAPI({
    name: nome,
    email: email,
    phone: telefone,
    message: mensagem
  });
  
  alert("Contato criado com sucesso!");
  contatoNome.value = "";
  contatoEmail.value = "";
  contatoTelefone.value = "";
  contatoMensagem.value = "";
}

// ========== WHATSAPP ==========
function salvarWhatsApp(){
  const phone = document.getElementById("whatsappPhone").value.trim();
  if(!phone) {
    alert("Digite o n√∫mero de WhatsApp!");
    return;
  }
  
  localStorage.setItem("whatsappPhone", phone);
  whatsappNumberDisplay.textContent = phone;
  
  // Enviar para API
  salvarWhatsAppAPI({
    phone_number: phone,
    message: ""
  });
  
  alert("N√∫mero de WhatsApp salvo com sucesso!");
}

function toggleWhatsAppMenu(){
  whatsappMenu.classList.toggle("show");
}

function enviarWhatsApp(){
  const msg = document.getElementById("whatsappMsgInput").value.trim();
  if(!msg) {
    alert("Digite uma mensagem!");
    return;
  }
  
  if(!whatsappNumberDisplay.textContent || whatsappNumberDisplay.textContent === "N√∫mero n√£o configurado") {
    alert("Configure o n√∫mero de WhatsApp primeiro!");
    return;
  }
  
  const url = `https://wa.me/${whatsappNumberDisplay.textContent}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
  document.getElementById("whatsappMsgInput").value = "";
  toggleWhatsAppMenu();
}

// ========== ADMIN ==========
function abrirAdmin(){
  telaAdmin.classList.remove("hide");
  telaCatalogo.classList.add("hide");
  telaCatalogoProdutos.classList.add("hide");
  telaHistorico.classList.add("hide");
  atualizarAdmin();
}

function voltarCatalogo(){
  telaCatalogo.classList.remove("hide");
  telaCatalogoProdutos.classList.remove("hide");
  telaAdmin.classList.add("hide");
  telaHistorico.classList.add("hide");
  renderCatalogo();
}

function atualizarAdmin(){
  atualizarListaCategorias();
  atualizarListaFormasPagamento();
  atualizarPaginaPagamento();
  atualizarListaIncompletos();
  atualizarHistorico();
  atualizarGrafico();
}

function criarUsuarioAdmin(){
  const novoUsuario = document.getElementById("novoUsuarioAdmin").value.trim();
  const novaSenha = document.getElementById("novaSenhaAdmin").value;
  const novoNivel = document.getElementById("novoNivelAdmin").value;
  
  if(!novoUsuario || !novaSenha) {
    alert("Preencha todos os campos!");
    return;
  }
  
  if(usuarios.find(x => x.nome === novoUsuario)) {
    alert("Este usu√°rio j√° existe!");
    return;
  }
  
  const novoUsuarioObj = { nome: novoUsuario, senha: novaSenha, nivel: novoNivel };
  usuarios.push(novoUsuarioObj);
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  
  // Enviar para API
  criarUsuarioAPI({
    name: novoUsuario,
    password: novaSenha,
    level: novoNivel
  });
  
  alert("Usu√°rio criado com sucesso!");
  document.getElementById("novoUsuarioAdmin").value = "";
  document.getElementById("novaSenhaAdmin").value = "";
}

// ========== GR√ÅFICO ==========
function atualizarGrafico(){
  const ctx = document.getElementById("grafico").getContext("2d");
  
  const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
  const dados = new Array(12).fill(0);
  
  pedidos.forEach(p => {
    const [dia, mes, ano] = p.data.split('/');
    const mesIdx = parseInt(mes) - 1;
    dados[mesIdx]++;
  });
  
  if(graficoInstancia) graficoInstancia.destroy();
  
  graficoInstancia = new Chart(ctx, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [{
        label: 'Pedidos por M√™s',
        data: dados,
        borderColor: '#2196F3',
        backgroundColor: 'rgba(33, 150, 243, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// ========== HIST√ìRICO ==========
function abrirHistorico(){
  telaHistorico.classList.remove("hide");
  telaCatalogo.classList.add("hide");
  telaCatalogoProdutos.classList.add("hide");
  telaAdmin.classList.add("hide");
  atualizarHistorico();
}

function atualizarAnosDisponiveis(){
  const anos = new Set();
  pedidos.forEach(p => {
    const ano = p.data.split('/')[2];
    if(ano) anos.add(ano);
  });
  
  const selectAno = document.getElementById('filtroAno');
  const anoAtual = selectAno.value;
  selectAno.innerHTML = '<option value="">Todos os Anos</option>';
  Array.from(anos).sort().reverse().forEach(ano => {
    const option = document.createElement('option');
    option.value = ano;
    option.textContent = ano;
    selectAno.appendChild(option);
  });
  selectAno.value = anoAtual;
}

function filtrarHistoricoPorData(){
  const data = document.getElementById('filtroData').value;
  const mes = document.getElementById('filtroMes').value;
  const ano = document.getElementById('filtroAno').value;
  
  pedidosFiltrados = pedidos.filter(p => {
    const [dia, mesP, anoP] = p.data.split('/');
    
    if(data){
      const [anoF, mesF, diaF] = data.split('-');
      return dia === diaF && mesP === mesF && anoP === anoF;
    }
    
    if(mes && !ano) return mesP === mes;
    if(ano && !mes) return anoP === ano;
    if(mes && ano) return mesP === mes && anoP === ano;
    
    return true;
  });
  
  renderHistorico(pedidosFiltrados);
}

function limparFiltrosData(){
  document.getElementById('filtroData').value = '';
  document.getElementById('filtroMes').value = '';
  document.getElementById('filtroAno').value = '';
  pedidosFiltrados = [];
  atualizarHistorico();
}

function atualizarHistorico(){
  atualizarAnosDisponiveis();
  renderHistorico(pedidos);
}

function renderHistorico(lista){
  listaHistorico.innerHTML = "";
  lista.forEach((p, i) => {
    const idxReal = pedidos.indexOf(p);
    const icon = p.status === 'fechado' ? 
      '<span class="status-icon status-fechado">‚úÖ Fechado</span>' : 
      '<span class="status-icon status-andamento">‚è≥ Em Andamento</span>';
    
    listaHistorico.innerHTML += `
      <div class="hist-item">
        <div class="hist-info">
          ${icon} <br>
          <strong>Pedido #${idxReal + 1}</strong> - R$ ${p.total} <br>
          <small>${p.data}</small>
        </div>
        <div class="hist-actions">
          <button onclick="exportarPDF(${idxReal})" style="background:#2196F3;">üìÑ PDF</button>
          <button onclick="exportarExcel(${idxReal})" style="background:#4CAF50;">üìä Excel</button>
          <button onclick="retomarPedido(${idxReal})">üîÑ Retomar</button>
          <button onclick="excluirPedidoHist(${idxReal})" style="background:#f44336;">üóëÔ∏è</button>
        </div>
      </div>`;
  });
  historicoAdmin.innerHTML = listaHistorico.innerHTML;
  atualizarGrafico();
}

function retomarPedido(i){
  const p = pedidos[i];
  carrinho = JSON.parse(JSON.stringify(p.itens));
  total.innerText = p.total;
  pagamento.value = p.pagamento || "";
  pedidoSendoEditadoIdx = i;
  voltarCatalogo();
  renderCatalogo();
  alert(`Pedido #${i + 1} retomado para edi√ß√£o.`);
}

function excluirPedidoHist(i){
  if(confirm("Deseja excluir este pedido do hist√≥rico?")) {
    pedidos.splice(i, 1);
    localStorage.setItem("pedidos", JSON.stringify(pedidos));
    atualizarHistorico();
  }
}

function limparHistorico(){
  if(confirm("Deseja limpar todo o hist√≥rico de pedidos?")) {
    pedidos = [];
    localStorage.setItem("pedidos", JSON.stringify(pedidos));
    atualizarHistorico();
  }
}

// ========== EXPORTAR ==========
function exportarPDF(i){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`Pedido #${i + 1}`, 10, 10);
  doc.text(`Total: R$ ${pedidos[i].total}`, 10, 20);
  doc.text(`Data: ${pedidos[i].data}`, 10, 30);
  doc.save(`pedido_${i + 1}.pdf`);
}

function exportarExcel(i){
  const ws = XLSX.utils.aoa_to_sheet([
    ["Pedido #" + (i + 1)],
    ["Total", pedidos[i].total],
    ["Data", pedidos[i].data]
  ]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Pedido");
  XLSX.writeFile(wb, `pedido_${i + 1}.xlsx`);
}

// ========== PRODUTOS INCOMPLETOS ==========
function atualizarListaIncompletos(){
  const container = document.getElementById('produtosIncompletos');
  if(produtosIncompletos.length === 0){
    container.innerHTML = '<p style="color: #666; font-style: italic;">Nenhum produto incompleto no momento. ‚úÖ</p>';
    return;
  }
  
  container.innerHTML = '';
  produtosIncompletos.forEach((p, i) => {
    const faltaDesc = !p.desc || p.desc === "Sem descri√ß√£o";
    const faltaPreco = !p.preco;
    const faltaEAN = !p.ean;
    const faltaCategoria = !p.categoria;
    
    let faltaHTML = '';
    if(faltaDesc) faltaHTML += '<span class="falta-item">üìù Descri√ß√£o</span>';
    if(faltaPreco) faltaHTML += '<span class="falta-item">üí∞ Pre√ßo</span>';
    if(faltaEAN) faltaHTML += '<span class="falta-item">üî¢ EAN-13</span>';
    if(faltaCategoria) faltaHTML += '<span class="falta-item">üìÇ Categoria</span>';
    
    container.innerHTML += `
      <div class="produto-incompleto">
        <img src="${p.img}" class="produto-incompleto-img">
        <div class="produto-incompleto-info">
          <h5>‚ö†Ô∏è Produto Incompleto #${i + 1}</h5>
          <p><strong>Descri√ß√£o:</strong> ${p.desc}</p>
          <p><strong>Pre√ßo:</strong> ${p.preco || "N√£o informado"}</p>
          <p><strong>EAN-13:</strong> ${p.ean || "N√£o informado"}</p>
          <p><strong>Categoria:</strong> ${p.categoria || "N√£o informado"}</p>
          <div class="falta-info">${faltaHTML}</div>
          <div class="produto-incompleto-actions">
            <button onclick="editarIncompleto(${i})" style="background: #2196F3;">‚úèÔ∏è Editar</button>
            <button onclick="completarIncompleto(${i})" style="background: #4CAF50;">‚úÖ Completar e Salvar</button>
            <button onclick="excluirIncompleto(${i})" style="background: #f44336;">üóëÔ∏è Descartar</button>
          </div>
        </div>
      </div>`;
  });
}

function editarIncompleto(i){
  const p = produtosIncompletos[i];
  pDesc.value = p.desc === "Sem descri√ß√£o" ? "" : p.desc;
  pPreco.value = p.preco;
  pEAN.value = p.ean;
  pCategoria.value = p.categoria;
  editandoIndice = -1;
  
  document.querySelector('h4').scrollIntoView();
  
  alert(`Editando produto incompleto #${i + 1}. Ap√≥s salvar, ele ser√° movido para produtos completos.`);
  
  window.incomepletoEmEdicao = i;
}

function completarIncompleto(i){
  const p = produtosIncompletos[i];
  pDesc.value = p.desc === "Sem descri√ß√£o" ? "" : p.desc;
  pPreco.value = p.preco;
  pEAN.value = p.ean;
  pCategoria.value = p.categoria;
  editandoIndice = -1;
  
  alert(`Editando produto incompleto #${i + 1}. Ap√≥s salvar, ele ser√° movido para produtos completos.`);
  
  window.incomepletoEmEdicao = i;
}

function excluirIncompleto(i){
  if(confirm("Deseja descartar este produto incompleto?")) {
    produtosIncompletos.splice(i, 1);
    localStorage.setItem("produtosIncompletos", JSON.stringify(produtosIncompletos));
    atualizarListaIncompletos();
  }
}

// ========== IMPORTA√á√ÉO EM LOTE ==========
function prepararLote(input){
  itensLote = [];
  const files = Array.from(input.files);
  let carregados = 0;
  files.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const jaExiste = produtos.find(p => p.img === e.target.result || p.desc === file.name.split('.')[0]);
      itensLote.push({ 
        img: e.target.result, 
        desc: file.name.split('.')[0], 
        preco: "", 
        ean: "",
        categoria: "",
        duplicado: !!jaExiste 
      });
      carregados++;
      if(carregados === files.length) renderLote();
    };
    reader.readAsDataURL(file);
  });
}

function renderLote(){
  areaLote.classList.remove("hide");
  listaLote.innerHTML = "";
  itensLote.forEach((item, i) => {
    const style = item.duplicado ? 'border: 2px solid #ff9800; background: #fff3e0;' : '';
    const aviso = item.duplicado ? '<small style="color:#e65100;">‚ö†Ô∏è J√° existe um produto similar!</small>' : '';
    let categoriasOptions = '<option value="">Sem categoria</option>';
    categorias.forEach(cat => {
      categoriasOptions += `<option value="${cat}" ${item.categoria === cat ? 'selected' : ''}>${cat}</option>`;
    });
    listaLote.innerHTML += `
      <div class="lote-item" style="${style}">
        <div class="lote-header">
          <img src="${item.img}">
          <div>
            <strong>Item ${i + 1}</strong> ${aviso}
          </div>
        </div>
        <div class="lote-inputs">
          <input placeholder="Descri√ß√£o" value="${item.desc}" oninput="itensLote[${i}].desc=this.value">
          <input placeholder="Pre√ßo" oninput="itensLote[${i}].preco=this.value">
          <input placeholder="EAN-13" oninput="itensLote[${i}].ean=this.value">
          <select oninput="itensLote[${i}].categoria=this.value">${categoriasOptions}</select>
        </div>
      </div>`;
  });
}

function salvarLote(){
  const timestamp = new Date().toLocaleString('pt-BR');
  let count = 0;
  let pulados = 0;
  let incompletos = 0;
  itensLote.forEach(item => {
    const duplicadoReal = produtos.find(p => (item.ean && p.ean === item.ean) || (p.desc === item.desc && p.img === item.img));
    if(!duplicadoReal && item.desc && item.preco){
      produtos.push({
        desc: item.desc,
        preco: parseFloat(item.preco.replace(',', '.')),
        ean: item.ean || "LOTE",
        categoria: item.categoria || "",
        img: item.img,
        criadoEm: timestamp,
        ultimaEdicao: timestamp
      });
      count++;
    } else if(!duplicadoReal && item.img){
      produtosIncompletos.push({
        desc: item.desc || "Sem descri√ß√£o",
        preco: item.preco || "",
        ean: item.ean || "",
        categoria: item.categoria || "",
        img: item.img,
        criadoEm: timestamp
      });
      incompletos++;
    } else {
      pulados++;
    }
  });
  localStorage.setItem("produtos", JSON.stringify(produtos));
  localStorage.setItem("produtosIncompletos", JSON.stringify(produtosIncompletos));
  areaLote.classList.add("hide");
  pLote.value = "";
  let msg = `${count} produtos cadastrados com sucesso!`;
  if(incompletos > 0) msg += ` (${incompletos} produtos incompletos salvos para edi√ß√£o)`;
  if(pulados > 0) msg += ` (${pulados} itens ignorados por serem duplicados)`;
  alert(msg);
  atualizarAdmin();
  renderCatalogo();
}
</script>

</body>
</html>
