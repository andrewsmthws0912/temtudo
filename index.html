<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üõí Tem Tudo ‚Äì Utilidades e Variedades</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins}
body{margin:0;background:#f2f4f7}
body.dark{background:#111;color:#fff}
header{background:#111;color:#fff;padding:15px;text-align:center}
footer{text-align:center;padding:10px;font-size:13px;opacity:.7}
.section{background:#fff;margin:20px;padding:20px;border-radius:14px}
body.dark .section{background:#1f1f1f}
button,input,textarea,select{
 width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc
}
button{background:#111;color:#fff;font-weight:600;cursor:pointer}

/* Grid com Rolagem Horizontal */
.grid-horizontal {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding-bottom: 15px;
    scroll-behavior: smooth;
}

.grid-horizontal::-webkit-scrollbar {
    height: 8px;
}

.grid-horizontal::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

body.dark .grid-horizontal::-webkit-scrollbar-track {
    background: #333;
}

.grid-horizontal::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.grid-horizontal::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.card { 
    position: relative; 
    overflow: visible; 
    background: #fff; 
    padding: 10px; 
    border-radius: 12px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    flex-shrink: 0;
    width: 220px;
    min-width: 220px;
}
body.dark .card { background: #2a2a2a; }

.img-container { position: relative; width: 100%; height: 150px; overflow: hidden; border-radius: 10px; cursor: crosshair; }
.card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.1s ease; }
.zoom-lens {
    position: absolute;
    border: 1px solid #d4d4d4;
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.4);
    display: none;
    pointer-events: none;
}

.price{color:green;font-weight:600}
.hide{display:none}
.admin-btn{background:#ff9800;color:#000}

.chart-container { width: 80%; margin: 0 auto; height: 200px; }
#grafico{width:100%!important;height:100%!important}

#assinatura{width:240px;height:70px;border:2px dashed #999;border-radius:10px}
body.dark #assinatura{border-color:#bbb}

.prod-admin{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:10px}
.prod-admin-info{flex:1}
.prod-admin-actions{display:flex;gap:5px}
.prod-admin-actions button{width:auto;padding:5px 10px}
.search-filter-container{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.search-filter-container input{flex:2;min-width:200px}
.search-filter-container select{flex:1;min-width:150px}
.timestamp{font-size:11px;color:#666;font-style:italic}
body.dark .timestamp{color:#aaa}

.status-icon { font-size: 18px; margin-right: 8px; }
.status-fechado { color: #4CAF50; }
.status-andamento { color: #FF9800; }

.lote-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; }
.lote-header { display: flex; gap: 10px; align-items: center; }
.lote-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
.lote-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
.lote-inputs input, .lote-inputs select { margin-top: 0; }

/* Hist√≥rico com Rolagem Horizontal */
.hist-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.hist-item { 
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: #f9f9f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

body.dark .hist-item {
    background: #2a2a2a;
    border-color: #444;
}

.hist-info { flex: 1; min-width: 200px; }
.hist-actions { 
    display: flex; 
    gap: 5px; 
    flex-wrap: wrap; 
    justify-content: flex-end;
    min-width: 300px;
}
.hist-actions button { width: auto; padding: 5px 10px; margin-top: 0; font-size: 12px; }

/* Categoria Badge */
.categoria-badge {
    display: inline-block;
    background: #2196F3;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 5px;
}

/* WhatsApp Floating Button */
.whatsapp-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

.whatsapp-btn {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #25D366 0%, #20BA5A 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
    transition: all 0.3s ease;
    border: none;
    color: white;
    font-size: 28px;
}

.whatsapp-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
}

.whatsapp-menu {
    position: absolute;
    bottom: 80px;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 12px;
    min-width: 250px;
    display: none;
}

.whatsapp-menu.show {
    display: block;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.whatsapp-menu input {
    width: 100%;
    padding: 8px;
    margin-bottom: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.whatsapp-menu button {
    width: 100%;
    padding: 8px;
    background: #25D366;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    margin-top: 0;
}

.whatsapp-menu button:hover {
    background: #20BA5A;
}

.whatsapp-info {
    font-size: 12px;
    color: #666;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

.whatsapp-number-display {
    font-size: 13px;
    color: #25D366;
    font-weight: 600;
    margin-top: 6px;
}

body.dark .whatsapp-menu {
    background: #1f1f1f;
    color: #fff;
}

body.dark .whatsapp-menu input {
    background: #2a2a2a;
    color: #fff;
    border-color: #444;
}

body.dark .whatsapp-info {
    color: #aaa;
    border-top-color: #444;
}

/* Alertas de Produtos Incompletos */
.alert-incompletos {
    background: #fff3cd;
    border: 2px solid #ffc107;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    color: #856404;
}

body.dark .alert-incompletos {
    background: #664d03;
    border-color: #997404;
    color: #ffecb5;
}

.alert-incompletos strong {
    display: block;
    margin-bottom: 8px;
}

.alert-incompletos button {
    width: auto;
    padding: 8px 15px;
    background: #ffc107;
    color: #000;
    margin-top: 8px;
}

/* Produto Incompleto */
.produto-incompleto {
    border: 2px solid #ff9800;
    background: #fff3e0;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    gap: 15px;
}

body.dark .produto-incompleto {
    background: #e65100;
    border-color: #ff6f00;
}

.produto-incompleto-img {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.produto-incompleto-info {
    flex: 1;
}

.produto-incompleto-info h5 {
    margin-top: 0;
    color: #e65100;
}

body.dark .produto-incompleto-info h5 {
    color: #ffb74d;
}

.falta-info {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 10px 0;
}

.falta-item {
    background: #ff5722;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
}

.produto-incompleto-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.produto-incompleto-actions button {
    width: auto;
    padding: 8px 12px;
    font-size: 12px;
    margin-top: 0;
}

/* Categorias */
.categoria-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #f9f9f9;
}

body.dark .categoria-item {
    background: #2a2a2a;
    border-color: #444;
}

.categoria-item button {
    width: auto;
    padding: 5px 10px;
    font-size: 12px;
    margin-top: 0;
}

/* Filtro de Data */
.filtro-data-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.filtro-data-container input {
    flex: 1;
    min-width: 150px;
}

.filtro-data-container button {
    width: auto;
    padding: 10px 20px;
}

/* Tema */
.theme-toggle {
    position: fixed;
    top: 15px;
    right: 15px;
    background: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    z-index: 999;
}

body.dark .theme-toggle {
    background: #333;
    color: #fff;
}
</style>
</head>
<body>

<header>
 <h1>üõí Tem Tudo ‚Äì Utilidades e Variedades</h1>
 <button class="theme-toggle" onclick="toggleTema()">üåó Claro / Escuro</button>
</header>

<!-- LOGIN -->
<div class="section" id="loginBox">
 <h3>Login</h3>
 <input id="loginUser" placeholder="Usu√°rio ou Email" onkeydown="if(event.key==='Enter') document.getElementById('loginSenha').focus()">
 <input id="loginSenha" type="password" placeholder="Senha" onkeydown="if(event.key==='Enter') document.getElementById('btnEntrar').click()">
 <button id="btnEntrar" onclick="login()">Entrar</button>
 <button onclick="esqueciSenha()">üîê Esqueci Minha Senha</button>
</div>

<!-- CAT√ÅLOGO -->
<div class="section hide" id="catalogo">
 <h2>Cat√°logo</h2>
 <div class="search-filter-container">
  <input id="busca" placeholder="üîç Buscar no cat√°logo..." onkeyup="renderCatalogo()">
  <select id="ordenacao" onchange="renderCatalogo()">
   <option value="relevancia">Mais Relevante</option>
   <option value="preco_asc">Menor Pre√ßo</option>
   <option value="preco_desc">Maior Pre√ßo</option>
   <option value="nome">Nome (A-Z)</option>
  </select>
  <select id="categoriaFiltro" onchange="renderCatalogo()">
   <option value="">Todas as Categorias</option>
  </select>
 </div>
 <select id="formaPagamento" onchange="atualizarTotal()">
  <option value="">Forma de pagamento</option>
 </select>
 <p>Total: R$ <span id="totalCarrinho">0.00</span></p>
 <div id="assinatura" style="display:none"></div>
 <div class="grid-horizontal" id="catalogo-grid"></div>
 <button onclick="limparAssignatura()" style="display:none" id="btnLimparAssinatura">Limpar Assinatura</button>
 <button onclick="salvarPedido()">üíæ Salvar Pedido</button>
 <button onclick="fecharPedido()">‚úîÔ∏è Fechar Pedido</button>
 <button onclick="verHistorico()">üìã Hist√≥rico de Pedidos</button>
 <button onclick="limparHistorico()">üóëÔ∏è Limpar Hist√≥rico</button>
 <button class="admin-btn" onclick="abrirPainel()">‚öôÔ∏è Painel Administrativo</button>
 <button onclick="logout()">üö™ Logout</button>
</div>

<!-- PAINEL ADMINISTRATIVO -->
<div class="section hide" id="painelAdmin">
 <h2>Painel Administrativo</h2>
 
 <!-- GR√ÅFICO -->
 <div class="chart-container">
  <canvas id="grafico"></canvas>
 </div>
 
 <!-- GERENCIAR CATEGORIAS -->
 <h3>üìÇ Gerenciar Categorias</h3>
 <div style="background:#4CAF50;color:#fff;padding:10px;border-radius:8px;margin-bottom:10px">
  <button onclick="adicionarCategoria()" style="background:#45a049;width:100%">‚ûï Adicionar Categoria</button>
 </div>
 <input id="novaCategoria" placeholder="Nome da categoria">
 <div id="listaCategorias"></div>
 
 <!-- CADASTRO DE PRODUTO -->
 <h3>üì¶ Cadastro de Produto</h3>
 <input id="nomeProduto" placeholder="Nome">
 <textarea id="descricaoProduto" placeholder="Descri√ß√£o"></textarea>
 <input id="precoProduto" type="number" placeholder="Pre√ßo (R$)">
 <select id="categoriaProduto">
  <option value="">Selecione uma categoria</option>
 </select>
 <button onclick="salvarProduto()">üíæ Salvar Produto</button>
 <button onclick="cancelarEdicao()">‚ùå Cancelar</button>
 
 <!-- PRODUTOS INCOMPLETOS -->
 <h3>‚ö†Ô∏è Produtos Incompletos (Pend√™ncias de Adi√ß√£o)</h3>
 <div id="produtosIncompletos"></div>
 
 <!-- IMPORTA√á√ÉO DE LISTA -->
 <h3>üì• Importa√ß√£o em Lista</h3>
 <div style="background:#2196F3;color:#fff;padding:10px;border-radius:8px;margin-bottom:10px">
  <button onclick="iniciarImportacaoLista()" style="background:#0b7dda;width:100%">üìä Importar/Adicionar Imagem</button>
 </div>
 
 <!-- CRIAR USU√ÅRIO -->
 <h3>üë§ Criar Usu√°rio</h3>
 <input id="novoUsuario" placeholder="Usu√°rio ou Email">
 <input id="novoUsuarioSenha" type="password" placeholder="Senha">
 <select id="nivelUsuario">
  <option value="cliente">Cliente</option>
  <option value="admin">Admin</option>
 </select>
 <button onclick="criarUsuario()">‚ûï Criar Usu√°rio</button>
 
 <!-- FORMAS DE PAGAMENTO -->
 <h3>üí≥ Formas de Pagamento</h3>
 <input id="novaFormaPagamento" placeholder="Nome da forma de pagamento">
 <button onclick="adicionarFormaPagamento()">‚ûï Adicionar</button>
 <div id="listaFormasPagamento"></div>
 
 <!-- CONTATOS -->
 <h3>üìß Criar Usu√°rio</h3>
 <input id="contatoNome" placeholder="Usu√°rio ou Email">
 <input id="contatoTelefone" placeholder="Telefone">
 <select id="contatoAdministrador">
  <option value="">Administrador</option>
 </select>
 <button onclick="criarContato()">üìß Criar Usu√°rio</button>
 
 <!-- WHATSAPP -->
 <h3>üí¨ Configurar WhatsApp</h3>
 <input id="whatsappInput" placeholder="Digite seu n√∫mero WhatsApp (com c√≥digo do pa√≠s)">
 <button onclick="salvarWhatsapp()">üíæ Salvar WhatsApp</button>
 
 <!-- PRODUTOS CADASTRADOS -->
 <h3>üìä Produtos Cadastrados</h3>
 <div id="listaProdutos"></div>
 
 <!-- HIST√ìRICO -->
 <h3>üìú Hist√≥rico</h3>
 <button onclick="voltarCatalogo()">‚Üê Voltar</button>
</div>

<!-- HIST√ìRICO DE PEDIDOS -->
<div class="section hide" id="historicoPedidos">
 <h2>üìã Hist√≥rico de Pedidos</h2>
 <div class="filtro-data-container">
  <input id="filtroDataInicio" type="date">
  <input id="filtroDataFim" type="date">
  <button onclick="filtrarPorData()">üîç Filtrar</button>
  <button onclick="limparFiltro()">üîÑ Limpar Filtro</button>
 </div>
 <div class="hist-container" id="listaHistorico"></div>
 <button onclick="voltarCatalogo()">‚Üê Voltar</button>
</div>

<!-- WHATSAPP FLUTUANTE -->
<div class="whatsapp-container">
 <button class="whatsapp-btn" onclick="toggleWhatsappMenu()">üí¨</button>
 <div class="whatsapp-menu" id="whatsappMenu">
  <input id="whatsappMensagem" placeholder="Digite sua mensagem" onkeydown="if(event.key==='Enter') enviarWhatsapp()">
  <button onclick="enviarWhatsapp()">üì§ Enviar</button>
  <div class="whatsapp-info">
   <strong>WhatsApp:</strong>
   <div class="whatsapp-number-display" id="whatsappDisplay">N√£o configurado</div>
  </div>
 </div>
</div>

<footer>
 Desenvolvido por: Andrews Pablo!
</footer>

<script>
/* ===== CONFIGURA√á√ÉO DA API ===== */
const API_URL = 'https://temtudo1.onrender.com/api';

/* ===== SENHA MESTRA ===== */
const SENHA_MESTRA = "mestra2026";

/* ===== FUN√á√ïES DE API ===== */
async function criarUsuarioAPI(usuario) {
  try {
    const response = await fetch(`${API_URL}/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(usuario)
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Usu√°rio criado na API');
      return true;
    }
  } catch (err) {
    console.error('Erro ao criar usu√°rio na API:', err);
  }
  return false;
}

async function criarCategoriaAPI(categoria) {
  try {
    const response = await fetch(`${API_URL}/categories`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: categoria })
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Categoria criada na API');
      return true;
    }
  } catch (err) {
    console.error('Erro ao criar categoria na API:', err);
  }
  return false;
}

async function criarProdutoAPI(produto) {
  try {
    const response = await fetch(`${API_URL}/products`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(produto)
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Produto criado na API');
      return true;
    }
  } catch (err) {
    console.error('Erro ao criar produto na API:', err);
  }
  return false;
}

async function criarPedidoAPI(pedido) {
  try {
    const response = await fetch(`${API_URL}/orders`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(pedido)
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Pedido criado na API');
      return true;
    }
  } catch (err) {
    console.error('Erro ao criar pedido na API:', err);
  }
  return false;
}

/* ===== ADMIN AUTOM√ÅTICO ===== */
(function(){
 let u = JSON.parse(localStorage.getItem("usuarios")||"{}");
 if(!u.admin){
  u.admin={senha:"1234",nivel:"admin"};
  localStorage.setItem("usuarios",JSON.stringify(u));
 }
})();

/* ===== DADOS ===== */
let usuarios=JSON.parse(localStorage.getItem("usuarios"));
let produtos=JSON.parse(localStorage.getItem("produtos")||"[]");
let produtosIncompletos=JSON.parse(localStorage.getItem("produtosIncompletos")||"[]");
let pedidos=JSON.parse(localStorage.getItem("pedidos")||"[]");
let categorias=JSON.parse(localStorage.getItem("categorias")||"[]");
let formasPagamento=JSON.parse(localStorage.getItem("formasPagamento")||"[]");
let contatos=JSON.parse(localStorage.getItem("contatos")||"[]");
let whatsappNumber = localStorage.getItem("whatsappNumber") || "";
let usuarioAtual=null,carrinho={};
let editandoIndice = -1;
let itensLote = [];
let pedidoSendoEditadoIdx = -1;
let pedidosFiltrados = [];

/* ===== PERSIST√äNCIA DE LOGIN ===== */
(function(){
 const sessao = JSON.parse(sessionStorage.getItem("sessaoAtual"));
 if(sessao){
  usuarioAtual = sessao;
  document.getElementById("loginBox").classList.add("hide");
  document.getElementById("catalogo").classList.remove("hide");
  if(sessao.nivel==="cliente")document.querySelector(".admin-btn").style.display="none";
  atualizarSelectCategorias();
  renderCatalogo();
 }
 atualizarWhatsappDisplay();
})();

/* ===== LOGIN ===== */
function login(){
 const user = document.getElementById("loginUser").value.trim();
 const senha = document.getElementById("loginSenha").value.trim();
 
 if (!user || !senha) {
  alert("Digite usu√°rio e senha!");
  return;
 }
 
 const u = usuarios[user];
 if (!u || u.senha !== senha) {
  alert("Usu√°rio ou senha inv√°lidos!");
  return;
 }
 
 usuarioAtual = {nome: user, nivel: u.nivel};
 sessionStorage.setItem("sessaoAtual", JSON.stringify(usuarioAtual));
 document.getElementById("loginBox").classList.add("hide");
 document.getElementById("catalogo").classList.remove("hide");
 if (u.nivel === "cliente") document.querySelector(".admin-btn").style.display = "none";
 atualizarSelectCategorias();
 renderCatalogo();
}

function esqueciSenha(){
 const m = prompt("Digite a SENHA MESTRA para redefinir:");
 if (m === SENHA_MESTRA) {
  const user = prompt("Digite o nome do usu√°rio:");
  if (usuarios[user]) {
   const nova = prompt("Digite a NOVA SENHA:");
   if (nova) {
    usuarios[user].senha = nova;
    localStorage.setItem("usuarios", JSON.stringify(usuarios));
    alert("Senha alterada com sucesso!");
   }
  } else {
   alert("Usu√°rio n√£o encontrado.");
  }
 } else {
  alert("Senha mestra incorreta.");
 }
}

/* ===== CATEGORIAS ===== */
function adicionarCategoria(){
 const nome = document.getElementById('novaCategoria').value.trim();
 if(!nome) return alert("Digite o nome da categoria");
 if(categorias.find(c => c.toLowerCase() === nome.toLowerCase())) return alert("Categoria j√° existe");
 categorias.push(nome);
 localStorage.setItem("categorias", JSON.stringify(categorias));
 criarCategoriaAPI(nome);
 document.getElementById('novaCategoria').value = '';
 atualizarSelectCategorias();
 renderListaCategorias();
}

function deletarCategoria(indice){
 if(confirm("Deletar categoria?")){
  categorias.splice(indice, 1);
  localStorage.setItem("categorias", JSON.stringify(categorias));
  atualizarSelectCategorias();
  renderListaCategorias();
 }
}

function atualizarSelectCategorias(){
 const select = document.getElementById('categoriaProduto');
 select.innerHTML = '<option value="">Selecione uma categoria</option>';
 categorias.forEach(cat => {
  const option = document.createElement('option');
  option.value = cat;
  option.textContent = cat;
  select.appendChild(option);
 });
 
 const filtro = document.getElementById('categoriaFiltro');
 filtro.innerHTML = '<option value="">Todas as Categorias</option>';
 categorias.forEach(cat => {
  const option = document.createElement('option');
  option.value = cat;
  option.textContent = cat;
  filtro.appendChild(option);
 });
 
 const adminSelect = document.getElementById('contatoAdministrador');
 adminSelect.innerHTML = '<option value="">Administrador</option>';
 Object.keys(usuarios).forEach(user => {
  if(usuarios[user].nivel === 'admin'){
   const option = document.createElement('option');
   option.value = user;
   option.textContent = user;
   adminSelect.appendChild(option);
  }
 });
}

function renderListaCategorias(){
 const lista = document.getElementById('listaCategorias');
 lista.innerHTML = '';
 categorias.forEach((cat, idx) => {
  const div = document.createElement('div');
  div.className = 'categoria-item';
  div.innerHTML = `
   <span>${cat}</span>
   <button onclick="deletarCategoria(${idx})">üóëÔ∏è Deletar</button>
  `;
  lista.appendChild(div);
 });
}

/* ===== PRODUTOS ===== */
function salvarProduto(){
 const nome = document.getElementById('nomeProduto').value.trim();
 const descricao = document.getElementById('descricaoProduto').value.trim();
 const preco = parseFloat(document.getElementById('precoProduto').value);
 const categoria = document.getElementById('categoriaProduto').value;
 
 if(!nome || !descricao || !preco || !categoria) return alert("Preencha todos os campos");
 
 const produto = {name: nome, description: descricao, price: preco, category: categoria, stock: 0};
 
 if(editandoIndice >= 0){
  produtos[editandoIndice] = produto;
  editandoIndice = -1;
 } else {
  produtos.push(produto);
 }
 
 localStorage.setItem("produtos", JSON.stringify(produtos));
 criarProdutoAPI(produto);
 
 document.getElementById('nomeProduto').value = '';
 document.getElementById('descricaoProduto').value = '';
 document.getElementById('precoProduto').value = '';
 document.getElementById('categoriaProduto').value = '';
 
 renderListaProdutos();
 renderCatalogo();
}

function cancelarEdicao(){
 editandoIndice = -1;
 document.getElementById('nomeProduto').value = '';
 document.getElementById('descricaoProduto').value = '';
 document.getElementById('precoProduto').value = '';
 document.getElementById('categoriaProduto').value = '';
}

function deletarProduto(indice){
 if(confirm("Deletar produto?")){
  produtos.splice(indice, 1);
  localStorage.setItem("produtos", JSON.stringify(produtos));
  renderListaProdutos();
  renderCatalogo();
 }
}

function renderListaProdutos(){
 const lista = document.getElementById('listaProdutos');
 lista.innerHTML = '';
 produtos.forEach((prod, idx) => {
  const div = document.createElement('div');
  div.className = 'prod-admin';
  div.innerHTML = `
   <div class="prod-admin-info">
    <strong>${prod.name}</strong> - R$ ${prod.price.toFixed(2)}<br>
    <small>${prod.category}</small>
   </div>
   <div class="prod-admin-actions">
    <button onclick="editarProduto(${idx})">‚úèÔ∏è Editar</button>
    <button onclick="deletarProduto(${idx})">üóëÔ∏è Deletar</button>
   </div>
  `;
  lista.appendChild(div);
 });
}

function editarProduto(indice){
 const prod = produtos[indice];
 document.getElementById('nomeProduto').value = prod.name;
 document.getElementById('descricaoProduto').value = prod.description;
 document.getElementById('precoProduto').value = prod.price;
 document.getElementById('categoriaProduto').value = prod.category;
 editandoIndice = indice;
 document.querySelector('html').scrollTop = 0;
}

function renderCatalogo(){
 const busca = document.getElementById('busca').value.toLowerCase();
 const categoria = document.getElementById('categoriaFiltro').value;
 const ordenacao = document.getElementById('ordenacao').value;
 
 let filtrados = produtos.filter(p => 
  (p.name.toLowerCase().includes(busca) || p.description.toLowerCase().includes(busca)) &&
  (!categoria || p.category === categoria)
 );
 
 if(ordenacao === 'preco_asc') filtrados.sort((a,b) => a.price - b.price);
 else if(ordenacao === 'preco_desc') filtrados.sort((a,b) => b.price - a.price);
 else if(ordenacao === 'nome') filtrados.sort((a,b) => a.name.localeCompare(b.name));
 
 const grid = document.getElementById('catalogo-grid');
 grid.innerHTML = '';
 
 filtrados.forEach((prod, idx) => {
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
   <div class="img-container">
    <img src="https://via.placeholder.com/220x150?text=${encodeURIComponent(prod.name)}" alt="${prod.name}">
   </div>
   <h4>${prod.name}</h4>
   <p>${prod.description}</p>
   <p class="price">R$ ${prod.price.toFixed(2)}</p>
   <button onclick="adicionarAoCarrinho('${prod.name}', ${prod.price})">üõí Adicionar</button>
  `;
  grid.appendChild(card);
 });
}

function adicionarAoCarrinho(nome, preco){
 if(!carrinho[nome]) carrinho[nome] = {preco, qtd: 0};
 carrinho[nome].qtd++;
 atualizarTotal();
}

function atualizarTotal(){
 let total = 0;
 Object.values(carrinho).forEach(item => total += item.preco * item.qtd);
 document.getElementById('totalCarrinho').textContent = total.toFixed(2);
}

/* ===== PEDIDOS ===== */
function salvarPedido(){
 const pedido = {
  data: new Date().toLocaleString(),
  usuario: usuarioAtual.nome,
  itens: carrinho,
  total: Object.values(carrinho).reduce((sum, item) => sum + (item.preco * item.qtd), 0),
  status: 'em_andamento',
  formaPagamento: document.getElementById('formaPagamento').value
 };
 
 if(pedidoSendoEditadoIdx >= 0){
  pedidos[pedidoSendoEditadoIdx] = pedido;
  pedidoSendoEditadoIdx = -1;
 } else {
  pedidos.push(pedido);
 }
 
 localStorage.setItem("pedidos", JSON.stringify(pedidos));
 criarPedidoAPI(pedido);
 alert("Pedido salvo com sucesso!");
}

function fecharPedido(){
 const s = prompt("Digite sua senha para FECHAR o pedido:");
 if(!s || usuarios[usuarioAtual.nome].senha !== s) return alert("Senha inv√°lida");
 
 const pedido = {
  data: new Date().toLocaleString(),
  usuario: usuarioAtual.nome,
  itens: carrinho,
  total: Object.values(carrinho).reduce((sum, item) => sum + (item.preco * item.qtd), 0),
  status: 'fechado',
  formaPagamento: document.getElementById('formaPagamento').value
 };
 
 pedidos.push(pedido);
 localStorage.setItem("pedidos", JSON.stringify(pedidos));
 criarPedidoAPI(pedido);
 
 carrinho = {};
 atualizarTotal();
 alert("Pedido fechado com sucesso!");
}

function verHistorico(){
 document.getElementById('catalogo').classList.add('hide');
 document.getElementById('historicoPedidos').classList.remove('hide');
 pedidosFiltrados = [...pedidos];
 renderHistorico();
}

function renderHistorico(){
 const lista = document.getElementById('listaHistorico');
 lista.innerHTML = '';
 
 pedidosFiltrados.forEach((ped, idx) => {
  const div = document.createElement('div');
  div.className = 'hist-item';
  const itensStr = Object.entries(ped.itens).map(([nome, item]) => `${nome} x${item.qtd}`).join(', ');
  div.innerHTML = `
   <div class="hist-info">
    <strong>${ped.data}</strong><br>
    ${itensStr}<br>
    Total: R$ ${ped.total.toFixed(2)} - ${ped.status}
   </div>
   <div class="hist-actions">
    <button onclick="editarPedido(${idx})">‚úèÔ∏è Editar</button>
    <button onclick="deletarPedido(${idx})">üóëÔ∏è Deletar</button>
   </div>
  `;
  lista.appendChild(div);
 });
}

function editarPedido(indice){
 const ped = pedidos[indice];
 carrinho = ped.itens;
 pedidoSendoEditadoIdx = indice;
 atualizarTotal();
 voltarCatalogo();
}

function deletarPedido(indice){
 if(confirm("Deletar pedido?")){
  pedidos.splice(indice, 1);
  localStorage.setItem("pedidos", JSON.stringify(pedidos));
  renderHistorico();
 }
}

function filtrarPorData(){
 const inicio = new Date(document.getElementById('filtroDataInicio').value);
 const fim = new Date(document.getElementById('filtroDataFim').value);
 
 pedidosFiltrados = pedidos.filter(ped => {
  const dataPed = new Date(ped.data);
  return dataPed >= inicio && dataPed <= fim;
 });
 
 renderHistorico();
}

function limparFiltro(){
 document.getElementById('filtroDataInicio').value = '';
 document.getElementById('filtroDataFim').value = '';
 pedidosFiltrados = [...pedidos];
 renderHistorico();
}

function limparHistorico(){
 if(confirm("Limpar todo o hist√≥rico?")){
  pedidos = [];
  localStorage.setItem("pedidos", JSON.stringify(pedidos));
  renderHistorico();
 }
}

/* ===== USU√ÅRIOS ===== */
function criarUsuario(){
 const user = document.getElementById('novoUsuario').value.trim();
 const senha = document.getElementById('novoUsuarioSenha').value.trim();
 const nivel = document.getElementById('nivelUsuario').value;
 
 if(!user || !senha) return alert("Preencha usu√°rio e senha");
 if(usuarios[user]) return alert("Usu√°rio j√° existe");
 
 usuarios[user] = {senha, nivel};
 localStorage.setItem("usuarios", JSON.stringify(usuarios));
 criarUsuarioAPI({name: user, password: senha, level: nivel});
 
 document.getElementById('novoUsuario').value = '';
 document.getElementById('novoUsuarioSenha').value = '';
 alert("Usu√°rio criado com sucesso!");
 atualizarSelectCategorias();
}

/* ===== FORMAS DE PAGAMENTO ===== */
function adicionarFormaPagamento(){
 const forma = document.getElementById('novaFormaPagamento').value.trim();
 if(!forma) return alert("Digite a forma de pagamento");
 if(formasPagamento.includes(forma)) return alert("Forma j√° existe");
 
 formasPagamento.push(forma);
 localStorage.setItem("formasPagamento", JSON.stringify(formasPagamento));
 
 document.getElementById('novaFormaPagamento').value = '';
 renderFormasPagamento();
 atualizarSelectFormasPagamento();
}

function deletarFormaPagamento(indice){
 if(confirm("Deletar forma de pagamento?")){
  formasPagamento.splice(indice, 1);
  localStorage.setItem("formasPagamento", JSON.stringify(formasPagamento));
  renderFormasPagamento();
  atualizarSelectFormasPagamento();
 }
}

function renderFormasPagamento(){
 const lista = document.getElementById('listaFormasPagamento');
 lista.innerHTML = '';
 formasPagamento.forEach((forma, idx) => {
  const div = document.createElement('div');
  div.className = 'categoria-item';
  div.innerHTML = `
   <span>${forma}</span>
   <button onclick="deletarFormaPagamento(${idx})">üóëÔ∏è Deletar</button>
  `;
  lista.appendChild(div);
 });
}

function atualizarSelectFormasPagamento(){
 const select = document.getElementById('formaPagamento');
 select.innerHTML = '<option value="">Forma de pagamento</option>';
 formasPagamento.forEach(forma => {
  const option = document.createElement('option');
  option.value = forma;
  option.textContent = forma;
  select.appendChild(option);
 });
}

/* ===== CONTATOS ===== */
function criarContato(){
 const nome = document.getElementById('contatoNome').value.trim();
 const telefone = document.getElementById('contatoTelefone').value.trim();
 const admin = document.getElementById('contatoAdministrador').value;
 
 if(!nome || !telefone || !admin) return alert("Preencha todos os campos");
 
 const contato = {nome, telefone, admin, data: new Date().toLocaleString()};
 contatos.push(contato);
 localStorage.setItem("contatos", JSON.stringify(contatos));
 
 document.getElementById('contatoNome').value = '';
 document.getElementById('contatoTelefone').value = '';
 document.getElementById('contatoAdministrador').value = '';
 alert("Contato criado com sucesso!");
}

/* ===== WHATSAPP ===== */
function salvarWhatsapp(){
 const numero = document.getElementById('whatsappInput').value.trim();
 if(!numero) return alert("Digite o n√∫mero do WhatsApp");
 
 whatsappNumber = numero;
 localStorage.setItem("whatsappNumber", numero);
 document.getElementById('whatsappInput').value = '';
 atualizarWhatsappDisplay();
 alert("WhatsApp salvo com sucesso!");
}

function atualizarWhatsappDisplay(){
 const display = document.getElementById('whatsappDisplay');
 display.textContent = whatsappNumber || "N√£o configurado";
}

function toggleWhatsappMenu(){
 document.getElementById('whatsappMenu').classList.toggle('show');
}

function enviarWhatsapp(){
 const mensagem = document.getElementById('whatsappMensagem').value.trim();
 if(!mensagem || !whatsappNumber) return alert("Configure o WhatsApp primeiro");
 
 const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(mensagem)}`;
 window.open(url, '_blank');
 document.getElementById('whatsappMensagem').value = '';
}

/* ===== PAINEL ADMINISTRATIVO ===== */
function abrirPainel(){
 document.getElementById('catalogo').classList.add('hide');
 document.getElementById('painelAdmin').classList.remove('hide');
 renderListaCategorias();
 renderListaProdutos();
 renderFormasPagamento();
 atualizarSelectCategorias();
 atualizarSelectFormasPagamento();
 gerarGrafico();
}

function voltarCatalogo(){
 document.getElementById('painelAdmin').classList.add('hide');
 document.getElementById('historicoPedidos').classList.add('hide');
 document.getElementById('catalogo').classList.remove('hide');
}

function gerarGrafico(){
 const ctx = document.getElementById('grafico').getContext('2d');
 const categoriaVendas = {};
 
 pedidos.forEach(ped => {
  Object.keys(ped.itens).forEach(nome => {
   const prod = produtos.find(p => p.name === nome);
   if(prod){
    if(!categoriaVendas[prod.category]) categoriaVendas[prod.category] = 0;
    categoriaVendas[prod.category] += ped.itens[nome].qtd;
   }
  });
 });
 
 new Chart(ctx, {
  type: 'bar',
  data: {
   labels: Object.keys(categoriaVendas),
   datasets: [{
    label: 'Vendas por Categoria',
    data: Object.values(categoriaVendas),
    backgroundColor: '#4CAF50'
   }]
  }
 });
}

function iniciarImportacaoLista(){
 alert("Fun√ß√£o de importa√ß√£o em desenvolvimento");
}

function limparAssignatura(){
 const canvas = document.getElementById('assinatura');
 const ctx = canvas.getContext('2d');
 ctx.clearRect(0, 0, canvas.width, canvas.height);
}

/* ===== TEMA ===== */
function toggleTema(){
 document.body.classList.toggle('dark');
 localStorage.setItem('tema', document.body.classList.contains('dark') ? 'dark' : 'light');
}

(function(){
 const tema = localStorage.getItem('tema');
 if(tema === 'dark') document.body.classList.add('dark');
})();

/* ===== LOGOUT ===== */
function logout(){
 if(confirm("Deseja sair?")){
  usuarioAtual = null;
  sessionStorage.removeItem("sessaoAtual");
  document.getElementById('loginBox').classList.remove('hide');
  document.getElementById('catalogo').classList.add('hide');
  document.getElementById('painelAdmin').classList.add('hide');
  document.getElementById('historicoPedidos').classList.add('hide');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginSenha').value = '';
 }
}

/* ===== INICIALIZA√á√ÉO ===== */
renderListaCategorias();
renderListaProdutos();
renderFormasPagamento();
atualizarSelectFormasPagamento();
</script>

</body>
</html>
