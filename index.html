<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üõí Tem Tudo ‚Äì Utilidades e Variedades</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins}
body{margin:0;background:#f2f4f7}
body.dark{background:#111;color:#fff}
header{background:#111;color:#fff;padding:15px;text-align:center}
footer{text-align:center;padding:10px;font-size:13px;opacity:.7}
.section{background:#fff;margin:20px;padding:20px;border-radius:14px}
body.dark .section{background:#1f1f1f}
button,input,textarea,select{
 width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc
}
button{background:#111;color:#fff;font-weight:600;cursor:pointer}

/* Grid com Rolagem Horizontal */
.grid-horizontal {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding-bottom: 15px;
    scroll-behavior: smooth;
}

.grid-horizontal::-webkit-scrollbar {
    height: 8px;
}

.grid-horizontal::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

body.dark .grid-horizontal::-webkit-scrollbar-track {
    background: #333;
}

.grid-horizontal::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.grid-horizontal::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.card { 
    position: relative; 
    overflow: visible; 
    background: #fff; 
    padding: 10px; 
    border-radius: 12px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    flex-shrink: 0;
    width: 220px;
    min-width: 220px;
}
body.dark .card { background: #2a2a2a; }

.img-container { position: relative; width: 100%; height: 150px; overflow: hidden; border-radius: 10px; cursor: crosshair; }
.card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.1s ease; }
.zoom-lens {
    position: absolute;
    border: 1px solid #d4d4d4;
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.4);
    display: none;
    pointer-events: none;
}

.price{color:green;font-weight:600}
.hide{display:none}
.admin-btn{background:#ff9800;color:#000}

.chart-container { width: 80%; margin: 0 auto; height: 200px; }
#grafico{width:100%!important;height:100%!important}

#assinatura{width:240px;height:70px;border:2px dashed #999;border-radius:10px}
body.dark #assinatura{border-color:#bbb}

.prod-admin{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:10px}
.prod-admin-info{flex:1}
.prod-admin-actions{display:flex;gap:5px}
.prod-admin-actions button{width:auto;padding:5px 10px}
.search-filter-container{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.search-filter-container input{flex:2;min-width:200px}
.search-filter-container select{flex:1;min-width:150px}
.timestamp{font-size:11px;color:#666;font-style:italic}
body.dark .timestamp{color:#aaa}

.status-icon { font-size: 18px; margin-right: 8px; }
.status-fechado { color: #4CAF50; }
.status-andamento { color: #FF9800; }

.lote-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; }
.lote-header { display: flex; gap: 10px; align-items: center; }
.lote-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
.lote-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
.lote-inputs input, .lote-inputs select { margin-top: 0; }

/* Hist√≥rico com Rolagem Horizontal */
.hist-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.hist-item { 
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: #f9f9f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

body.dark .hist-item {
    background: #2a2a2a;
    border-color: #444;
}

.hist-info { flex: 1; min-width: 200px; }
.hist-actions { 
    display: flex; 
    gap: 5px; 
    flex-wrap: wrap; 
    justify-content: flex-end;
    min-width: 300px;
}
.hist-actions button { width: auto; padding: 5px 10px; margin-top: 0; font-size: 12px; }

/* Categoria Badge */
.categoria-badge {
    display: inline-block;
    background: #2196F3;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 5px;
}

/* WhatsApp Floating Button */
.whatsapp-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

.whatsapp-btn {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #25D366 0%, #20BA5A 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
    transition: all 0.3s ease;
    border: none;
    color: white;
    font-size: 28px;
}

.whatsapp-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
}

.whatsapp-menu {
    position: absolute;
    bottom: 80px;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 12px;
    min-width: 250px;
    display: none;
}

.whatsapp-menu.show {
    display: block;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.whatsapp-menu input {
    width: 100%;
    padding: 8px;
    margin-bottom: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.whatsapp-menu button {
    width: 100%;
    padding: 8px;
    background: #25D366;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    margin-top: 0;
}

.whatsapp-menu button:hover {
    background: #20BA5A;
}

.whatsapp-info {
    font-size: 12px;
    color: #666;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

.whatsapp-number-display {
    font-size: 13px;
    color: #25D366;
    font-weight: 600;
    margin-top: 6px;
}

body.dark .whatsapp-menu {
    background: #1f1f1f;
    color: #fff;
}

body.dark .whatsapp-menu input {
    background: #2a2a2a;
    color: #fff;
    border-color: #444;
}

body.dark .whatsapp-info {
    color: #aaa;
    border-top-color: #444;
}

/* Alertas de Produtos Incompletos */
.alert-incompletos {
    background: #fff3cd;
    border: 2px solid #ffc107;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    color: #856404;
}

body.dark .alert-incompletos {
    background: #664d03;
    border-color: #997404;
    color: #ffecb5;
}

.alert-incompletos strong {
    display: block;
    margin-bottom: 8px;
}

.alert-incompletos button {
    width: auto;
    padding: 8px 15px;
    background: #ffc107;
    color: #000;
    margin-top: 8px;
}

/* Produto Incompleto */
.produto-incompleto {
    border: 2px solid #ff9800;
    background: #fff3e0;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    gap: 15px;
}

body.dark .produto-incompleto {
    background: #e65100;
    border-color: #ff6f00;
}

.produto-incompleto-img {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.produto-incompleto-info {
    flex: 1;
}

.produto-incompleto-info h5 {
    margin-top: 0;
    color: #e65100;
}

body.dark .produto-incompleto-info h5 {
    color: #ffb74d;
}

.falta-info {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 10px 0;
}

.falta-item {
    background: #ff5722;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
}

.produto-incompleto-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.produto-incompleto-actions button {
    width: auto;
    padding: 8px 12px;
    font-size: 12px;
    margin-top: 0;
}

/* Categorias */
.categoria-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #f9f9f9;
}

body.dark .categoria-item {
    background: #2a2a2a;
    border-color: #444;
}

.categoria-item button {
    width: auto;
    padding: 5px 10px;
    font-size: 12px;
    margin-top: 0;
}

/* Filtro de Data */
.filtro-data-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.filtro-data-container input {
    flex: 1;
    min-width: 150px;
    margin-top: 0;
}

.filtro-data-container button {
    width: auto;
    padding: 10px 15px;
    margin-top: 0;
}

.api-status {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    font-weight: 600;
}

.api-status.connected {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.api-status.disconnected {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

body.dark .api-status.connected {
    background: #1e4620;
    color: #a6e3a1;
    border-color: #2d5a2d;
}

body.dark .api-status.disconnected {
    background: #5a2c2c;
    color: #f8a5a5;
    border-color: #7a3c3c;
}
</style>
</head>

<body>

<header>
<h2>üõí Tem Tudo ‚Äì Utilidades e Variedades</h2>
<button onclick="toggleTheme()">üåó Claro / Escuro</button>
</header>

<div id="apiStatus" class="api-status disconnected">üî¥ Desconectado da API</div>

<!-- LOGIN -->
<div id="loginBox" class="section">
 <h3>Login</h3>
 <input type="text" id="loginUser" placeholder="Usu√°rio">
 <input type="password" id="loginSenha" placeholder="Senha">
 <button onclick="login()">Entrar</button>
 <button onclick="esqueciSenha()" style="background:#666;margin-top:5px">Esqueci a Senha</button>
 <p style="text-align:center;font-size:12px;opacity:0.7">Usu√°rio padr√£o: <strong>admin</strong> | Senha: <strong>1234</strong></p>
</div>

<!-- CATALOGO -->
<div id="catalogo" class="hide">

 <!-- HEADER COM TEMA -->
 <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 20px">
  <h3 id="usuarioDisplay"></h3>
  <button onclick="logout()" style="width:auto;padding:8px 15px;margin:0">Sair</button>
 </div>

 <!-- ADMIN PANEL -->
 <div class="section admin-btn" style="background:#ffe0b2;color:#000">
  <h4>‚öôÔ∏è PAINEL ADMINISTRATIVO</h4>

  <!-- GERENCIAR USU√ÅRIOS -->
  <div style="margin-bottom:20px">
   <h5>üë• Gerenciar Usu√°rios</h5>
   <input type="text" id="novoUsuario" placeholder="Nome do usu√°rio">
   <input type="password" id="novoSenha" placeholder="Senha">
   <select id="novoNivel">
    <option value="">Selecione o n√≠vel</option>
    <option value="admin">Admin</option>
    <option value="cliente">Cliente</option>
   </select>
   <button onclick="criarUsuario()" style="background:#4CAF50">‚ûï Criar Usu√°rio</button>
   <div id="listaUsuarios" style="margin-top:10px"></div>
  </div>

  <!-- GERENCIAR CATEGORIAS -->
  <div style="margin-bottom:20px">
   <h5>üìÇ Gerenciar Categorias</h5>
   <input type="text" id="novaCategoria" placeholder="Nome da categoria">
   <button onclick="adicionarCategoria()" style="background:#2196F3">‚ûï Adicionar Categoria</button>
   <div id="listaCategoriasAdmin" style="margin-top:10px"></div>
  </div>

  <!-- GERENCIAR FORMAS DE PAGAMENTO -->
  <div style="margin-bottom:20px">
   <h5>üí≥ Gerenciar Formas de Pagamento</h5>
   <input type="text" id="novaFormaPagamento" placeholder="Nome da forma de pagamento">
   <button onclick="adicionarFormaPagamento()" style="background:#FF9800">‚ûï Adicionar Forma de Pagamento</button>
   <div id="listaFormasPagamento" style="margin-top:10px"></div>
  </div>

  <!-- GERENCIAR CONTATOS -->
  <div style="margin-bottom:20px">
   <h5>üìß Gerenciar Contatos</h5>
   <input type="text" id="novoContatoNome" placeholder="Nome">
   <input type="email" id="novoContatoEmail" placeholder="Email">
   <input type="tel" id="novoContatoTelefone" placeholder="Telefone">
   <textarea id="novoContatoMensagem" placeholder="Mensagem" style="height:80px"></textarea>
   <button onclick="adicionarContato()" style="background:#9C27B0">‚ûï Adicionar Contato</button>
   <div id="listaContatos" style="margin-top:10px"></div>
  </div>

  <!-- GERENCIAR WHATSAPP -->
  <div style="margin-bottom:20px">
   <h5>üì± Gerenciar WhatsApp</h5>
   <input type="text" id="novoWhatsapp" placeholder="N√∫mero WhatsApp (com c√≥digo pa√≠s)">
   <button onclick="adicionarWhatsapp()" style="background:#25D366">‚ûï Salvar WhatsApp</button>
   <div id="listaWhatsapp" style="margin-top:10px"></div>
  </div>

  <!-- CADASTRO DE PRODUTOS -->
  <div style="margin-bottom:20px">
   <h5>üì¶ Cadastro de Produtos</h5>
   <input type="text" id="pDesc" placeholder="Descri√ß√£o do produto">
   <input type="number" id="pPreco" placeholder="Pre√ßo (R$)" step="0.01">
   <input type="text" id="pEAN" placeholder="EAN-13">
   <select id="pCategoria">
    <option value="">Selecione uma categoria</option>
   </select>
   <input type="file" id="pImg" accept="image/*">
   <button onclick="salvarProduto()" style="background:#4CAF50">üíæ Salvar Produto</button>
   <div id="listaAdmin" style="margin-top:10px"></div>
  </div>

  <!-- IMPORTAR LOTE -->
  <div style="margin-bottom:20px">
   <h5>üì• Importar Lote de Produtos</h5>
   <textarea id="pLote" placeholder="Cole aqui o JSON com os produtos (array de objetos)"></textarea>
   <button onclick="processarLote()" style="background:#FF5722">üì§ Processar Lote</button>
   <div id="areaLote" class="hide"></div>
  </div>

  <!-- PRODUTOS INCOMPLETOS -->
  <div style="margin-bottom:20px">
   <h5>‚ö†Ô∏è Produtos Incompletos</h5>
   <div id="produtosIncompletos"></div>
  </div>

  <!-- GR√ÅFICO DE VENDAS -->
  <div style="margin-bottom:20px">
   <h5>üìä Gr√°fico de Vendas por M√™s</h5>
   <div class="chart-container">
    <canvas id="grafico"></canvas>
   </div>
  </div>

  <!-- HIST√ìRICO DE PEDIDOS -->
  <div style="margin-bottom:20px">
   <h5>üìã Hist√≥rico de Pedidos</h5>
   <div class="filtro-data-container">
    <input type="date" id="filtroData">
    <select id="filtroMes">
     <option value="">Todos os Meses</option>
     <option value="01">Janeiro</option>
     <option value="02">Fevereiro</option>
     <option value="03">Mar√ßo</option>
     <option value="04">Abril</option>
     <option value="05">Maio</option>
     <option value="06">Junho</option>
     <option value="07">Julho</option>
     <option value="08">Agosto</option>
     <option value="09">Setembro</option>
     <option value="10">Outubro</option>
     <option value="11">Novembro</option>
     <option value="12">Dezembro</option>
    </select>
    <select id="filtroAno">
     <option value="">Todos os Anos</option>
    </select>
    <button onclick="filtrarHistoricoPorData()" style="width:auto;padding:10px 15px">üîç Filtrar</button>
    <button onclick="limparFiltrosData()" style="width:auto;padding:10px 15px;background:#666">üîÑ Limpar</button>
   </div>
   <div id="historico" class="hist-container"></div>
  </div>
 </div>

 <!-- CAT√ÅLOGO DE PRODUTOS -->
 <div class="section">
  <h3>üõçÔ∏è Cat√°logo</h3>
  <div class="search-filter-container">
   <input type="text" id="searchProduto" placeholder="üîç Buscar produto..." onkeyup="renderCatalogo()">
   <select id="filterCategoria" onchange="renderCatalogo()">
    <option value="">Todas as Categorias</option>
   </select>
  </div>
  <div id="catalogo_grid" class="grid-horizontal"></div>
 </div>

 <!-- CARRINHO -->
 <div class="section">
  <h3>üõí Carrinho</h3>
  <div id="carrinho_grid" class="grid-horizontal"></div>
  <h4>Total: R$ <span id="total">0.00</span></h4>
  <select id="pagamento">
   <option value="">Selecione a forma de pagamento</option>
  </select>
  <button onclick="salvarPedido()" style="background:#FF9800">üíæ Salvar Pedido</button>
  <button onclick="fecharPedido()" style="background:#4CAF50">‚úÖ Fechar Pedido</button>
  <button onclick="limparCamposPedido()" style="background:#f44336">üóëÔ∏è Limpar Carrinho</button>
  <canvas id="assinatura"></canvas>
  <button onclick="limparAssinatura()" style="background:#666;margin-top:5px">üßπ Limpar Assinatura</button>
 </div>

</div>

<!-- WHATSAPP FLOATING BUTTON -->
<div class="whatsapp-container">
 <button class="whatsapp-btn" onclick="toggleWhatsappMenu()">üí¨</button>
 <div id="whatsappMenu" class="whatsapp-menu">
  <input type="text" id="whatsappInput" placeholder="N√∫mero WhatsApp (com c√≥digo pa√≠s)">
  <button onclick="abrirWhatsapp()">üì± Abrir WhatsApp</button>
  <div class="whatsapp-info">
   <strong>N√∫mero Salvo:</strong>
   <div id="whatsappNumberDisplay" class="whatsapp-number-display">Carregando...</div>
  </div>
 </div>
</div>

<footer>
 Desenvolvido por: Andrews Pablo | Data: 16 de Janeiro de 2026
</footer>

<script>
/* ========== CONFIGURA√á√ÉO DA API ========== */
const API_URL = 'https://temtudo1.onrender.com/api';

/* ========== VERIFICAR CONEX√ÉO COM API ========== */
async function verificarConexaoAPI() {
  try {
    const response = await fetch(`${API_URL}/health`);
    const data = await response.json();
    if (data.success) {
      document.getElementById('apiStatus').className = 'api-status connected';
      document.getElementById('apiStatus').textContent = 'üü¢ Conectado √† API';
      return true;
    }
  } catch (err) {
    document.getElementById('apiStatus').className = 'api-status disconnected';
    document.getElementById('apiStatus').textContent = 'üî¥ Desconectado da API';
    return false;
  }
}

/* ========== FUN√á√ïES DE INTEGRA√á√ÉO COM API ========== */

// Criar usu√°rio na API
async function criarUsuarioAPI(usuario) {
  try {
    const response = await fetch(`${API_URL}/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(usuario)
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Usu√°rio criado na API');
    }
  } catch (err) {
    console.error('Erro ao criar usu√°rio na API:', err);
  }
}

// Criar categoria na API
async function criarCategoriaAPI(categoria) {
  try {
    const response = await fetch(`${API_URL}/categories`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(categoria)
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Categoria criada na API');
    }
  } catch (err) {
    console.error('Erro ao criar categoria na API:', err);
  }
}

// Criar produto na API
async function criarProdutoAPI(produto) {
  try {
    const response = await fetch(`${API_URL}/products`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(produto)
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Produto criado na API');
    }
  } catch (err) {
    console.error('Erro ao criar produto na API:', err);
  }
}

// Criar pedido na API
async function criarPedidoAPI(pedido) {
  try {
    const response = await fetch(`${API_URL}/orders`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(pedido)
    });
    const data = await response.json();
    if (data.success) {
      console.log('‚úÖ Pedido criado na API');
    }
  } catch (err) {
    console.error('Erro ao criar pedido na API:', err);
  }
}

/* ===== CONFIGURA√á√ïES ===== */
const SENHA_MESTRA = "MESTRA2026";

/* ===== ADMIN AUTOM√ÅTICO ===== */
(function(){
 let u = JSON.parse(localStorage.getItem("usuarios")||"{}");
 if(!u.admin){
  u.admin={senha:"1234",nivel:"admin"};
  localStorage.setItem("usuarios",JSON.stringify(u));
 }
})();

/* ===== DADOS ===== */
let usuarios=JSON.parse(localStorage.getItem("usuarios"));
let produtos=JSON.parse(localStorage.getItem("produtos")||"[]");
let produtosIncompletos=JSON.parse(localStorage.getItem("produtosIncompletos")||"[]");
let pedidos=JSON.parse(localStorage.getItem("pedidos")||"[]");
let categorias=JSON.parse(localStorage.getItem("categorias")||"[]");
let formasPagamento=JSON.parse(localStorage.getItem("formasPagamento")||"[]");
let contatos=JSON.parse(localStorage.getItem("contatos")||"[]");
let whatsappNumbers=JSON.parse(localStorage.getItem("whatsappNumbers")||"[]");
let usuarioAtual=null,carrinho={};
let editandoIndice = -1;
let itensLote = [];
let pedidoSendoEditadoIdx = -1;
let pedidosFiltrados = [];

/* ===== VERIFICAR CONEX√ÉO NA INICIALIZA√á√ÉO ===== */
verificarConexaoAPI();
setInterval(verificarConexaoAPI, 30000); // Verificar a cada 30 segundos

/* ===== PERSIST√äNCIA DE LOGIN ===== */
(function(){
 const sessao = JSON.parse(sessionStorage.getItem("sessaoAtual"));
 if(sessao){
  usuarioAtual = sessao;
  loginBox.classList.add("hide");
  catalogo.classList.remove("hide");
  document.getElementById('usuarioDisplay').textContent = `üë§ ${sessao.nome}`;
  if(sessao.nivel==="cliente")document.querySelector(".admin-btn").style.display="none";
  atualizarSelectCategorias();
  atualizarSelectFormasPagamento();
  atualizarWhatsappDisplay();
  renderCatalogo();
 }
})();

/* ===== LOGIN ===== */
function login(){
 const u=usuarios[loginUser.value];
 if(!u||u.senha!==loginSenha.value)return alert("Login inv√°lido");
 usuarioAtual={nome:loginUser.value,nivel:u.nivel};
 sessionStorage.setItem("sessaoAtual", JSON.stringify(usuarioAtual));
 loginBox.classList.add("hide");
 catalogo.classList.remove("hide");
 document.getElementById('usuarioDisplay').textContent = `üë§ ${usuarioAtual.nome}`;
 if(u.nivel==="cliente")document.querySelector(".admin-btn").style.display="none";
 atualizarSelectCategorias();
 atualizarSelectFormasPagamento();
 atualizarWhatsappDisplay();
 renderCatalogo();
}

function logout(){
 sessionStorage.removeItem("sessaoAtual");
 usuarioAtual = null;
 loginBox.classList.remove("hide");
 catalogo.classList.add("hide");
 loginUser.value = "";
 loginSenha.value = "";
}

function esqueciSenha(){
 const m = prompt("Digite a SENHA MESTRA para redefinir:");
 if(m === SENHA_MESTRA){
  const user = prompt("Digite o nome do usu√°rio:");
  if(usuarios[user]){
   const nova = prompt("Digite a NOVA SENHA:");
   usuarios[user].senha = nova;
   localStorage.setItem("usuarios", JSON.stringify(usuarios));
   alert("Senha alterada com sucesso!");
  } else {
   alert("Usu√°rio n√£o encontrado.");
  }
 } else {
  alert("Senha mestra incorreta.");
 }
}

/* ===== USU√ÅRIOS ===== */
function criarUsuario(){
 const nome = document.getElementById('novoUsuario').value.trim();
 const senha = document.getElementById('novoSenha').value.trim();
 const nivel = document.getElementById('novoNivel').value;
 
 if(!nome || !senha || !nivel) return alert("Preencha todos os campos");
 if(usuarios[nome]) return alert("Usu√°rio j√° existe");
 
 usuarios[nome] = {senha: senha, nivel: nivel};
 localStorage.setItem("usuarios", JSON.stringify(usuarios));
 
 // Enviar para API
 criarUsuarioAPI({
  name: nome,
  password: senha,
  level: nivel
 });
 
 document.getElementById('novoUsuario').value = '';
 document.getElementById('novoSenha').value = '';
 document.getElementById('novoNivel').value = '';
 atualizarListaUsuarios();
 alert("Usu√°rio criado com sucesso!");
}

function atualizarListaUsuarios(){
 const lista = document.getElementById('listaUsuarios');
 lista.innerHTML = '';
 for(let user in usuarios){
  if(user !== 'admin'){
   lista.innerHTML += `
    <div class="categoria-item">
     <span>${user} (${usuarios[user].nivel})</span>
     <button onclick="excluirUsuario('${user}')" style="background:#f44336">üóëÔ∏è</button>
    </div>`;
  }
 }
}

function excluirUsuario(nome){
 if(confirm("Excluir usu√°rio?")){
  delete usuarios[nome];
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  atualizarListaUsuarios();
 }
}

/* ===== CATEGORIAS ===== */
function adicionarCategoria(){
 const nome = document.getElementById('novaCategoria').value.trim();
 if(!nome) return alert("Digite o nome da categoria");
 if(categorias.find(c => c.toLowerCase() === nome.toLowerCase())) return alert("Categoria j√° existe");
 categorias.push(nome);
 localStorage.setItem("categorias", JSON.stringify(categorias));
 
 // Enviar para API
 criarCategoriaAPI({
  name: nome,
  description: nome
 });
 
 document.getElementById('novaCategoria').value = '';
 atualizarSelectCategorias();
 atualizarListaCategorias();
 alert("Categoria adicionada com sucesso!");
}

function excluirCategoria(idx){
 if(confirm("Deseja excluir esta categoria?")){
  categorias.splice(idx, 1);
  localStorage.setItem("categorias", JSON.stringify(categorias));
  atualizarSelectCategorias();
  atualizarListaCategorias();
 }
}

function atualizarSelectCategorias(){
 const selects = [document.getElementById('pCategoria'), document.getElementById('filterCategoria')];
 selects.forEach(select => {
  if(!select) return;
  const valor = select.value;
  select.innerHTML = select.id === 'pCategoria' ? '<option value="">Selecione uma categoria</option>' : '<option value="">Todas as Categorias</option>';
  categorias.forEach(cat => {
   const option = document.createElement('option');
   option.value = cat;
   option.textContent = cat;
   select.appendChild(option);
  });
  select.value = valor;
 });
}

function atualizarListaCategorias(){
 const lista = document.getElementById('listaCategoriasAdmin');
 lista.innerHTML = '';
 categorias.forEach((cat, idx) => {
  lista.innerHTML += `
   <div class="categoria-item">
    <span>üìÇ ${cat}</span>
    <button onclick="excluirCategoria(${idx})" style="background:#f44336">üóëÔ∏è</button>
   </div>`;
 });
}

/* ===== FORMAS DE PAGAMENTO ===== */
function adicionarFormaPagamento(){
 const nome = document.getElementById('novaFormaPagamento').value.trim();
 if(!nome) return alert("Digite o nome da forma de pagamento");
 if(formasPagamento.find(f => f.toLowerCase() === nome.toLowerCase())) return alert("Forma de pagamento j√° existe");
 formasPagamento.push(nome);
 localStorage.setItem("formasPagamento", JSON.stringify(formasPagamento));
 document.getElementById('novaFormaPagamento').value = '';
 atualizarSelectFormasPagamento();
 atualizarListaFormasPagamento();
 alert("Forma de pagamento adicionada com sucesso!");
}

function excluirFormaPagamento(idx){
 if(confirm("Deseja excluir esta forma de pagamento?")){
  formasPagamento.splice(idx, 1);
  localStorage.setItem("formasPagamento", JSON.stringify(formasPagamento));
  atualizarSelectFormasPagamento();
  atualizarListaFormasPagamento();
 }
}

function atualizarSelectFormasPagamento(){
 const select = document.getElementById('pagamento');
 if(!select) return;
 const valor = select.value;
 select.innerHTML = '<option value="">Selecione a forma de pagamento</option>';
 formasPagamento.forEach(forma => {
  const option = document.createElement('option');
  option.value = forma;
  option.textContent = forma;
  select.appendChild(option);
 });
 select.value = valor;
}

function atualizarListaFormasPagamento(){
 const lista = document.getElementById('listaFormasPagamento');
 lista.innerHTML = '';
 formasPagamento.forEach((forma, idx) => {
  lista.innerHTML += `
   <div class="categoria-item">
    <span>üí≥ ${forma}</span>
    <button onclick="excluirFormaPagamento(${idx})" style="background:#f44336">üóëÔ∏è</button>
   </div>`;
 });
}

/* ===== CONTATOS ===== */
function adicionarContato(){
 const nome = document.getElementById('novoContatoNome').value.trim();
 const email = document.getElementById('novoContatoEmail').value.trim();
 const telefone = document.getElementById('novoContatoTelefone').value.trim();
 const mensagem = document.getElementById('novoContatoMensagem').value.trim();
 
 if(!nome || !email) return alert("Preencha nome e email");
 
 const contato = {
  nome: nome,
  email: email,
  telefone: telefone,
  mensagem: mensagem,
  data: new Date().toLocaleString('pt-BR')
 };
 
 contatos.push(contato);
 localStorage.setItem("contatos", JSON.stringify(contatos));
 
 document.getElementById('novoContatoNome').value = '';
 document.getElementById('novoContatoEmail').value = '';
 document.getElementById('novoContatoTelefone').value = '';
 document.getElementById('novoContatoMensagem').value = '';
 
 atualizarListaContatos();
 alert("Contato adicionado com sucesso!");
}

function excluirContato(idx){
 if(confirm("Deseja excluir este contato?")){
  contatos.splice(idx, 1);
  localStorage.setItem("contatos", JSON.stringify(contatos));
  atualizarListaContatos();
 }
}

function atualizarListaContatos(){
 const lista = document.getElementById('listaContatos');
 lista.innerHTML = '';
 contatos.forEach((contato, idx) => {
  lista.innerHTML += `
   <div class="categoria-item" style="flex-direction:column;align-items:flex-start">
    <strong>${contato.nome}</strong>
    <small>üìß ${contato.email} | üì± ${contato.telefone || 'N/A'}</small>
    <small style="color:#666">${contato.mensagem}</small>
    <small style="color:#999">${contato.data}</small>
    <button onclick="excluirContato(${idx})" style="background:#f44336;width:auto;padding:5px 10px;margin-top:5px">üóëÔ∏è Excluir</button>
   </div>`;
 });
}

/* ===== WHATSAPP ===== */
function adicionarWhatsapp(){
 const numero = document.getElementById('novoWhatsapp').value.trim();
 if(!numero) return alert("Digite um n√∫mero v√°lido");
 if(whatsappNumbers.find(w => w === numero)) return alert("N√∫mero j√° existe");
 
 whatsappNumbers.push(numero);
 localStorage.setItem("whatsappNumbers", JSON.stringify(whatsappNumbers));
 document.getElementById('novoWhatsapp').value = '';
 atualizarListaWhatsapp();
 atualizarWhatsappDisplay();
 alert("N√∫mero WhatsApp adicionado com sucesso!");
}

function excluirWhatsapp(idx){
 if(confirm("Deseja excluir este n√∫mero?")){
  whatsappNumbers.splice(idx, 1);
  localStorage.setItem("whatsappNumbers", JSON.stringify(whatsappNumbers));
  atualizarListaWhatsapp();
  atualizarWhatsappDisplay();
 }
}

function atualizarListaWhatsapp(){
 const lista = document.getElementById('listaWhatsapp');
 lista.innerHTML = '';
 whatsappNumbers.forEach((numero, idx) => {
  lista.innerHTML += `
   <div class="categoria-item">
    <span>üì± ${numero}</span>
    <button onclick="excluirWhatsapp(${idx})" style="background:#f44336">üóëÔ∏è</button>
   </div>`;
 });
}

function atualizarWhatsappDisplay(){
 const display = document.getElementById('whatsappNumberDisplay');
 if(whatsappNumbers.length > 0){
  display.textContent = whatsappNumbers[0];
 } else {
  display.textContent = 'Nenhum n√∫mero configurado';
 }
}

function toggleWhatsappMenu(){
    const menu = document.getElementById('whatsappMenu');
    menu.classList.toggle('show');
    if(menu.classList.contains('show')){
        document.getElementById('whatsappInput').value = whatsappNumbers[0] || '';
        document.getElementById('whatsappInput').focus();
    }
}

function abrirWhatsapp(){
    const numero = document.getElementById('whatsappInput').value.trim();
    if(!numero){
        alert("Por favor, digite um n√∫mero de WhatsApp v√°lido");
        return;
    }
    const url = `https://wa.me/${numero}?text=Ol√°! Gostaria de mais informa√ß√µes sobre os produtos.`;
    window.open(url, '_blank');
}

/* ===== PRODUTOS ===== */
function renderCatalogo(){
 const search = document.getElementById('searchProduto').value.toLowerCase();
 const categoria = document.getElementById('filterCategoria').value;
 const grid = document.getElementById('catalogo_grid');
 
 grid.innerHTML = '';
 produtos.forEach((p, i) => {
  if((p.desc.toLowerCase().includes(search)) && (!categoria || p.categoria === categoria)){
   grid.innerHTML += `
    <div class="card">
     <div class="img-container">
      <img src="${p.img}" alt="${p.desc}">
     </div>
     <strong>${p.desc}</strong>
     <p class="price">R$ ${p.preco.toFixed(2)}</p>
     <small style="color:#666">EAN: ${p.ean || '---'}</small>
     <br>
     <small class="categoria-badge">üìÇ ${p.categoria || 'Sem categoria'}</small>
     <br>
     <input type="number" id="qtd_${i}" value="1" min="1" style="margin-top:5px;padding:5px">
     <button onclick="add(${i}, document.getElementById('qtd_${i}').value)" style="margin-top:5px">üõí Adicionar</button>
    </div>`;
  }
 });
}

function add(i,q){
 q=Number(q);
 if(q>0)carrinho[i]={q:q,preco:Number(produtos[i].preco), desc: produtos[i].desc, ean: produtos[i].ean || "---", categoria: produtos[i].categoria || "---"};
 else delete carrinho[i];
 calcularTotal();
 renderCarrinho();
}

function calcularTotal(){
 let t=0;
 for(let k in carrinho)t+=carrinho[k].q*carrinho[k].preco;
 document.getElementById('total').innerText=t.toFixed(2);
}

function renderCarrinho(){
 const grid = document.getElementById('carrinho_grid');
 grid.innerHTML = '';
 for(let i in carrinho){
  const item = carrinho[i];
  grid.innerHTML += `
   <div class="card">
    <strong>${item.desc}</strong>
    <p class="price">R$ ${item.preco.toFixed(2)}</p>
    <small>Qtd: ${item.q}</small>
    <br>
    <small class="categoria-badge">üìÇ ${item.categoria}</small>
    <br>
    <input type="number" id="qtd_carr_${i}" value="${item.q}" min="1" style="margin-top:5px;padding:5px">
    <button onclick="add(${i}, document.getElementById('qtd_carr_${i}').value)" style="margin-top:5px;background:#2196F3">‚úèÔ∏è Atualizar</button>
    <button onclick="add(${i}, 0)" style="margin-top:5px;background:#f44336">üóëÔ∏è Remover</button>
   </div>`;
 }
}

/* ===== EXPORTA√á√ÉO PDF ===== */
function exportarPDF(idx){
    const p = pedidos[idx];
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text("Tem Tudo - Utilidades e Variedades", 105, 15, { align: "center" });
    doc.setFontSize(10);
    doc.text(`Data: ${p.data}`, 105, 22, { align: "center" });
    doc.text(`Forma de Pagamento: ${p.pagamento || 'N√£o informada'}`, 105, 27, { align: "center" });
    
    const rows = [];
    for(let k in p.itens){
        rows.push([
            p.itens[k].ean || "---",
            p.itens[k].desc, 
            p.itens[k].categoria || "---",
            `R$ ${p.itens[k].preco.toFixed(2)}`, 
            p.itens[k].q, 
            `R$ ${(p.itens[k].preco * p.itens[k].q).toFixed(2)}`
        ]);
    }
    
    doc.autoTable({
        head: [['EAN-13', 'Produto', 'Categoria', 'Pre√ßo Unit.', 'Qtd', 'Subtotal']],
        body: rows,
        startY: 35,
        theme: 'striped',
        headStyles: { fillColor: [17, 17, 17] },
        foot: [['', '', '', '', 'TOTAL:', `R$ ${p.total}`]],
        footStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' }
    });
    
    const finalY = doc.lastAutoTable.finalY || 35;
    doc.setFontSize(10);
    doc.text("Assinatura do Cliente: ___________________________", 10, finalY + 20);
    doc.setFontSize(9);
    doc.setTextColor(100);
    doc.text("Desenvolvido por: Andrews Pablo!", 105, 285, { align: "center" });
    doc.save(`pedido_${idx+1}.pdf`);
}

/* ===== EXPORTA√á√ÉO EXCEL ===== */
function exportarExcel(idx){
    const p = pedidos[idx];
    const data = [
        ["Tem Tudo - Utilidades e Variedades"],
        ["RELAT√ìRIO DE PEDIDO PROFISSIONAL"],
        ["Data:", p.data],
        ["Pagamento:", p.pagamento || "N√£o informado"],
        [],
        ["EAN-13", "DESCRI√á√ÉO DO PRODUTO", "CATEGORIA", "PRE√áO UNIT.", "QUANTIDADE", "SUBTOTAL"]
    ];
    
    for(let k in p.itens) {
        data.push([
            p.itens[k].ean || "---", 
            p.itens[k].desc, 
            p.itens[k].categoria || "---",
            p.itens[k].preco, 
            p.itens[k].q, 
            p.itens[k].preco * p.itens[k].q
        ]);
    }
    
    data.push([], ["", "", "", "", "TOTAL GERAL:", parseFloat(p.total)], [], ["Desenvolvido por: Andrews Pablo!"]);
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    const colWidths = data.reduce((acc, row) => {
        row.forEach((cell, i) => {
            const cellLen = cell ? cell.toString().length : 0;
            acc[i] = Math.max(acc[i] || 10, cellLen + 2);
        });
        return acc;
    }, []);
    ws['!cols'] = colWidths.map(w => ({ wch: w }));
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Pedido");
    XLSX.writeFile(wb, `pedido_${idx+1}.xlsx`);
}

/* ===== PEDIDOS ===== */
function salvarPedido(){
    if(!Object.keys(carrinho).length) return alert("Carrinho vazio");
    const novoPedido = {
        total: document.getElementById('total').innerText,
        data: new Date().toLocaleString('pt-BR'),
        status: 'andamento',
        pagamento: document.getElementById('pagamento').value,
        itens: JSON.parse(JSON.stringify(carrinho))
    };
    if(pedidoSendoEditadoIdx >= 0){
        pedidos[pedidoSendoEditadoIdx] = novoPedido;
        pedidoSendoEditadoIdx = -1;
    } else {
        pedidos.push(novoPedido);
    }
    localStorage.setItem("pedidos", JSON.stringify(pedidos));
    
    // Enviar para API
    criarPedidoAPI({
      user_id: null,
      total_price: parseFloat(document.getElementById('total').innerText),
      status: 'pending'
    });
    
    alert("Pedido salvo como 'Em Andamento'!");
    limparCamposPedido();
    atualizarHistorico();
}

function fecharPedido(){
    const s=prompt("Digite sua senha para FECHAR o pedido:");
    if(!s||usuarios[usuarioAtual.nome].senha!==s)return alert("Senha inv√°lida");
    if(!Object.keys(carrinho).length) return alert("Carrinho vazio");
    const novoPedido = {
        total: document.getElementById('total').innerText,
        data: new Date().toLocaleString('pt-BR'),
        status: 'fechado',
        pagamento: document.getElementById('pagamento').value,
        itens: JSON.parse(JSON.stringify(carrinho))
    };
    if(pedidoSendoEditadoIdx >= 0){
        pedidos[pedidoSendoEditadoIdx] = novoPedido;
        pedidoSendoEditadoIdx = -1;
    } else {
        pedidos.push(novoPedido);
    }
    localStorage.setItem("pedidos", JSON.stringify(pedidos));
    
    // Enviar para API
    criarPedidoAPI({
      user_id: null,
      total_price: parseFloat(document.getElementById('total').innerText),
      status: 'completed'
    });
    
    alert("Pedido fechado com sucesso!");
    limparCamposPedido();
    atualizarHistorico();
}

function limparCamposPedido(){
    carrinho={}; 
    document.getElementById('total').innerText="0.00"; 
    document.getElementById('pagamento').value="";
    const c = document.getElementById('assinatura');
    const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);
    renderCatalogo();
    renderCarrinho();
}

/* ===== FILTRO DE DATA NO HIST√ìRICO ===== */
function atualizarAnosDisponiveis(){
    const anos = new Set();
    pedidos.forEach(p => {
        const ano = p.data.split('/')[2];
        if(ano) anos.add(ano);
    });
    
    const selectAno = document.getElementById('filtroAno');
    const anoAtual = selectAno.value;
    selectAno.innerHTML = '<option value="">Todos os Anos</option>';
    Array.from(anos).sort().reverse().forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
    });
    selectAno.value = anoAtual;
}

function filtrarHistoricoPorData(){
    const data = document.getElementById('filtroData').value;
    const mes = document.getElementById('filtroMes').value;
    const ano = document.getElementById('filtroAno').value;
    
    pedidosFiltrados = pedidos.filter(p => {
        const [dia, mesP, anoP] = p.data.split('/');
        
        if(data){
            const [anoF, mesF, diaF] = data.split('-');
            return dia === diaF && mesP === mesF && anoP === anoF;
        }
        
        if(mes && !ano) return mesP === mes;
        if(ano && !mes) return anoP === ano;
        if(mes && ano) return mesP === mes && anoP === ano;
        
        return true;
    });
    
    renderHistorico(pedidosFiltrados);
}

function limparFiltrosData(){
    document.getElementById('filtroData').value = '';
    document.getElementById('filtroMes').value = '';
    document.getElementById('filtroAno').value = '';
    pedidosFiltrados = [];
    atualizarHistorico();
}

function renderHistorico(lista = pedidos){
    const container = document.getElementById('historico');
    container.innerHTML = '';
    
    if(lista.length === 0){
        container.innerHTML = '<p style="color: #666; font-style: italic;">Nenhum pedido encontrado. üì≠</p>';
        return;
    }
    
    lista.forEach((p, idx) => {
        const statusClass = p.status === 'fechado' ? 'status-fechado' : 'status-andamento';
        const statusIcon = p.status === 'fechado' ? '‚úÖ' : '‚è≥';
        
        let itensHTML = '';
        for(let k in p.itens){
            itensHTML += `<small>‚Ä¢ ${p.itens[k].desc} (${p.itens[k].q}x)</small><br>`;
        }
        
        container.innerHTML += `
        <div class="hist-item">
            <div class="hist-info">
                <strong><span class="status-icon ${statusClass}">${statusIcon}</span> Pedido #${idx+1}</strong><br>
                <small>üìÖ ${p.data} | üí≥ ${p.pagamento || 'N/A'}</small><br>
                <small><strong>Total: R$ ${p.total}</strong></small><br>
                <small style="color:#666">${itensHTML}</small>
            </div>
            <div class="hist-actions">
                <button onclick="editarPedido(${idx})" style="background:#2196F3">‚úèÔ∏è Editar</button>
                <button onclick="exportarPDF(${idx})" style="background:#FF5722">üìÑ PDF</button>
                <button onclick="exportarExcel(${idx})" style="background:#4CAF50">üìä Excel</button>
                <button onclick="excluirPedido(${idx})" style="background:#f44336">üóëÔ∏è</button>
            </div>
        </div>`;
    });
}

function atualizarHistorico(){
    atualizarAnosDisponiveis();
    renderHistorico();
    atualizarGrafico();
}

function editarPedido(idx){
    const p = pedidos[idx];
    carrinho = JSON.parse(JSON.stringify(p.itens));
    document.getElementById('total').innerText = p.total;
    document.getElementById('pagamento').value = p.pagamento;
    pedidoSendoEditadoIdx = idx;
    renderCarrinho();
    window.scrollTo(0, 0);
}

function excluirPedido(idx){
    if(confirm("Deseja excluir este pedido?")){
        pedidos.splice(idx, 1);
        localStorage.setItem("pedidos", JSON.stringify(pedidos));
        atualizarHistorico();
    }
}

/* ===== IMPORTAR LOTE ===== */
function processarLote(){
    try {
        itensLote = JSON.parse(document.getElementById('pLote').value);
        if(!Array.isArray(itensLote)) throw new Error("Deve ser um array");
        
        const areaLote = document.getElementById('areaLote');
        areaLote.innerHTML = '';
        
        itensLote.forEach((item, i) => {
            areaLote.innerHTML += `
            <div class="lote-item">
                <div class="lote-header">
                    <img src="${item.img}" alt="Produto">
                    <strong>#${i+1}</strong>
                </div>
                <div class="lote-inputs">
                    <input type="text" id="lote_desc_${i}" value="${item.desc || ''}" placeholder="Descri√ß√£o">
                    <input type="number" id="lote_preco_${i}" value="${item.preco || ''}" placeholder="Pre√ßo" step="0.01">
                    <input type="text" id="lote_ean_${i}" value="${item.ean || ''}" placeholder="EAN-13">
                    <select id="lote_cat_${i}">
                        <option value="">Selecione categoria</option>
                        ${categorias.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </div>
            </div>`;
        });
        
        areaLote.innerHTML += '<button onclick="salvarLote()" style="background:#4CAF50;margin-top:10px">‚úÖ Salvar Lote</button>';
        areaLote.classList.remove("hide");
        document.querySelector('h4').scrollIntoView();
    } catch(e) {
        alert("JSON inv√°lido: " + e.message);
    }
}

function salvarLote(){
    const timestamp = new Date().toLocaleString('pt-BR');
    let count = 0;
    let pulados = 0;
    let incompletos = 0;
    itensLote.forEach((item, i) => {
        const desc = document.getElementById(`lote_desc_${i}`).value;
        const preco = parseFloat(document.getElementById(`lote_preco_${i}`).value);
        const ean = document.getElementById(`lote_ean_${i}`).value;
        const categoria = document.getElementById(`lote_cat_${i}`).value;
        
        const duplicadoReal = produtos.find(p => (ean && p.ean === ean) || (p.desc === desc && p.img === item.img));
        if(!duplicadoReal && desc && !isNaN(preco)){
            produtos.push({
                desc: desc,
                preco: preco,
                ean: ean || "LOTE",
                categoria: categoria || "",
                img: item.img,
                criadoEm: timestamp,
                ultimaEdicao: timestamp
            });
            count++;
        } else if(!duplicadoReal && item.img){
            produtosIncompletos.push({
                desc: desc || "Sem descri√ß√£o",
                preco: preco || "",
                ean: ean || "",
                categoria: categoria || "",
                img: item.img,
                criadoEm: timestamp
            });
            incompletos++;
        } else {
            pulados++;
        }
    });
    localStorage.setItem("produtos", JSON.stringify(produtos));
    localStorage.setItem("produtosIncompletos", JSON.stringify(produtosIncompletos));
    document.getElementById('areaLote').classList.add("hide");
    document.getElementById('pLote').value = "";
    let msg = `${count} produtos cadastrados com sucesso!`;
    if(incompletos > 0) msg += ` (${incompletos} produtos incompletos salvos para edi√ß√£o)`;
    if(pulados > 0) msg += ` (${pulados} itens ignorados por serem duplicados)`;
    alert(msg);
    atualizarAdmin();
    renderCatalogo();
}

/* ===== EDITAR PRODUTOS INCOMPLETOS ===== */
function atualizarListaIncompletos(){
    const container = document.getElementById('produtosIncompletos');
    if(produtosIncompletos.length === 0){
        container.innerHTML = '<p style="color: #666; font-style: italic;">Nenhum produto incompleto no momento. ‚úÖ</p>';
        return;
    }
    
    container.innerHTML = '';
    produtosIncompletos.forEach((p, i) => {
        const faltaDesc = !p.desc || p.desc === "Sem descri√ß√£o";
        const faltaPreco = !p.preco;
        const faltaEAN = !p.ean;
        const faltaCategoria = !p.categoria;
        
        let faltaHTML = '';
        if(faltaDesc) faltaHTML += '<span class="falta-item">üìù Descri√ß√£o</span>';
        if(faltaPreco) faltaHTML += '<span class="falta-item">üí∞ Pre√ßo</span>';
        if(faltaEAN) faltaHTML += '<span class="falta-item">üî¢ EAN-13</span>';
        if(faltaCategoria) faltaHTML += '<span class="falta-item">üìÇ Categoria</span>';
        
        container.innerHTML += `
        <div class="produto-incompleto">
            <img src="${p.img}" class="produto-incompleto-img">
            <div class="produto-incompleto-info">
                <h5>‚ö†Ô∏è Produto Incompleto #${i+1}</h5>
                <p><strong>Descri√ß√£o:</strong> ${p.desc}</p>
                <p><strong>Pre√ßo:</strong> ${p.preco || "N√£o informado"}</p>
                <p><strong>EAN-13:</strong> ${p.ean || "N√£o informado"}</p>
                <p><strong>Categoria:</strong> ${p.categoria || "N√£o informado"}</p>
                <div class="falta-info">${faltaHTML}</div>
                <div class="produto-incompleto-actions">
                    <button onclick="editarIncompleto(${i})" style="background: #2196F3;">‚úèÔ∏è Editar</button>
                    <button onclick="completarIncompleto(${i})" style="background: #4CAF50;">‚úÖ Completar e Salvar</button>
                    <button onclick="excluirIncompleto(${i})" style="background: #f44336;">üóëÔ∏è Descartar</button>
                </div>
            </div>
        </div>`;
    });
}

function editarIncompleto(i){
    const p = produtosIncompletos[i];
    document.getElementById('pDesc').value = p.desc === "Sem descri√ß√£o" ? "" : p.desc;
    document.getElementById('pPreco').value = p.preco;
    document.getElementById('pEAN').value = p.ean;
    document.getElementById('pCategoria').value = p.categoria;
    editandoIndice = -1;
    
    document.querySelector('h4').scrollIntoView();
    
    alert(`Editando produto incompleto #${i+1}. Ap√≥s salvar, ele ser√° movido para produtos completos.`);
    window.incomepletoEmEdicao = i;
}

function completarIncompleto(i){
    const p = produtosIncompletos[i];
    document.getElementById('pDesc').value = p.desc === "Sem descri√ß√£o" ? "" : p.desc;
    document.getElementById('pPreco').value = p.preco;
    document.getElementById('pEAN').value = p.ean;
    document.getElementById('pCategoria').value = p.categoria;
    editandoIndice = -1;
    window.incomepletoEmEdicao = i;
    salvarProduto();
}

function excluirIncompleto(i){
    if(confirm("Descartar este produto?")){
        produtosIncompletos.splice(i, 1);
        localStorage.setItem("produtosIncompletos", JSON.stringify(produtosIncompletos));
        atualizarListaIncompletos();
    }
}

/* ===== GR√ÅFICO DE VENDAS POR M√äS ===== */
let graficoInstance = null;
function atualizarGrafico(){
    if(graficoInstance) graficoInstance.destroy();
    
    // Agrupar vendas por m√™s
    const vendasPorMes = {};
    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    
    pedidos.forEach(p => {
        const [dia, mes, ano] = p.data.split('/');
        const chave = `${meses[parseInt(mes)-1]}/${ano}`;
        vendasPorMes[chave] = (vendasPorMes[chave] || 0) + parseFloat(p.total);
    });
    
    const labels = Object.keys(vendasPorMes).sort();
    const dados = labels.map(l => vendasPorMes[l]);
    
    graficoInstance = new Chart(document.getElementById('grafico'), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Vendas por M√™s (R$)",
                data: dados,
                borderColor: '#111',
                backgroundColor: 'rgba(0,0,0,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#111'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Vendas (R$)' }
                }
            }
        }
    });
}

/* ===== RESTANTE DAS FUN√á√ïES ===== */
function salvarProduto(){
 const precoStr = document.getElementById('pPreco').value.replace(',', '.');
 const precoFormatado = parseFloat(precoStr);
 if(!document.getElementById('pDesc').value || isNaN(precoFormatado)) return alert("Preencha descri√ß√£o e pre√ßo corretamente!");
 if(!document.getElementById('pCategoria').value) return alert("Selecione uma categoria!");
 if(editandoIndice === -1){
    const existe = produtos.find(p => p.desc === document.getElementById('pDesc').value || (document.getElementById('pEAN').value && p.ean === document.getElementById('pEAN').value));
    if(existe && !confirm("J√° existe um produto com este nome ou EAN. Deseja cadastrar mesmo assim?")) return;
 }
 const timestamp = new Date().toLocaleString('pt-BR');
 const acao = (img) => {
    if(editandoIndice >= 0){
        produtos[editandoIndice] = {...produtos[editandoIndice], desc:document.getElementById('pDesc').value, preco:precoFormatado, ean:document.getElementById('pEAN').value, categoria:document.getElementById('pCategoria').value, img:img||produtos[editandoIndice].img, ultimaEdicao:timestamp};
        editandoIndice = -1;
    } else {
        produtos.push({desc:document.getElementById('pDesc').value, preco:precoFormatado, ean:document.getElementById('pEAN').value, categoria:document.getElementById('pCategoria').value, img:img, criadoEm:timestamp, ultimaEdicao:timestamp});
        if(window.incomepletoEmEdicao !== undefined){
            produtosIncompletos.splice(window.incomepletoEmEdicao, 1);
            localStorage.setItem("produtosIncompletos", JSON.stringify(produtosIncompletos));
            window.incomepletoEmEdicao = undefined;
        }
    }
    localStorage.setItem("produtos",JSON.stringify(produtos));
    document.getElementById('pDesc').value=document.getElementById('pPreco').value=document.getElementById('pEAN').value=""; document.getElementById('pImg').value=""; document.getElementById('pCategoria').value="";
    atualizarAdmin(); renderCatalogo();
    
    // Enviar para API
    criarProdutoAPI({
      name: document.getElementById('pDesc').value,
      description: document.getElementById('pDesc').value,
      price: precoFormatado,
      category_id: null,
      image_url: img,
      stock: 10
    });
 };
 if(document.getElementById('pImg').files[0]){
    const r=new FileReader();
    r.onload=()=>acao(r.result);
    r.readAsDataURL(document.getElementById('pImg').files[0]);
 } else acao();
}

function atualizarAdmin(){
 const listaAdmin = document.getElementById('listaAdmin');
 listaAdmin.innerHTML="";
 produtos.forEach((p,i)=>{
  listaAdmin.innerHTML+=`
   <div class="prod-admin">
    <div class="prod-admin-info">
     <strong>${p.desc}</strong> - R$ ${p.preco.toFixed(2)} <br>
     <span class="categoria-badge">üìÇ ${p.categoria || "Sem categoria"}</span> <br>
     <span class="timestamp">EAN: ${p.ean || '---'} | Editado: ${p.ultimaEdicao || p.criadoEm}</span>
    </div>
    <div class="prod-admin-actions">
     <button onclick="editarProduto(${i})">‚úèÔ∏è</button>
     <button onclick="excluirProduto(${i})">üóëÔ∏è</button>
    </div>
   </div>`;
 });
 atualizarHistorico();
 atualizarListaIncompletos();
}

function editarProduto(i){
 const p=produtos[i];
 document.getElementById('pDesc').value=p.desc; 
 document.getElementById('pPreco').value=p.preco; 
 document.getElementById('pEAN').value=p.ean; 
 document.getElementById('pCategoria').value=p.categoria;
 editandoIndice = i;
 window.scrollTo(0,0);
}

function excluirProduto(i){
 if(confirm("Excluir produto?")){
  produtos.splice(i,1);
  localStorage.setItem("produtos",JSON.stringify(produtos));
  atualizarAdmin(); renderCatalogo();
 }
}

const c=document.getElementById("assinatura"),ctx=c.getContext("2d");
let desenhando=false;
c.addEventListener("mousedown",()=>desenhando=true);
c.addEventListener("mouseup",()=>desenhando=false);
c.addEventListener("mousemove",(e)=>{
 if(!desenhando)return;
 const rect=c.getBoundingClientRect();
 ctx.fillStyle="#000";
 ctx.beginPath();
 ctx.arc(e.clientX-rect.left,e.clientY-rect.top,2,0,Math.PI*2);
 ctx.fill();
});

function limparAssinatura(){
 ctx.clearRect(0,0,c.width,c.height);
}

function toggleTheme(){
 document.body.classList.toggle("dark");
 localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
}

// Aplicar tema salvo
if(localStorage.getItem("theme") === "dark"){
 document.body.classList.add("dark");
}

// Inicializar
atualizarListaUsuarios();
atualizarListaCategorias();
atualizarListaFormasPagamento();
atualizarListaContatos();
atualizarListaWhatsapp();
</script>

</body>
</html>
